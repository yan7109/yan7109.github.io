<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>How to Sell Your Startup: A Founder's Guide to M&A Exits | Derek Yan</title>
<meta name="description" content="A practical guide to startup M&A from a founder who led the end-to-end acquisition of his $13.5M-funded company. 4 years, 100+ conversations, and hard lessons on finding buyers, negotiating term sheets, and closing deals.">
<meta name="keywords" content="startup M&A, how to sell a startup, startup exit, selling your company, founder exit guide, startup acquisition, M&A advisor, sell my startup, tech company acquisition, startup sale process, term sheet negotiation, due diligence, acquihire">
<meta name="author" content="Derek Z. H. Yan">
<link rel="canonical" href="https://yan7109.github.io/startup-ma.html">

<!-- Open Graph -->
<meta property="og:type" content="article">
<meta property="og:title" content="How to Sell Your Startup: A Founder's Guide to M&A Exits">
<meta property="og:description" content="A practical guide from a founder who led the end-to-end acquisition of his $13.5M-funded startup. 4 years, 100+ conversations, and hard lessons learned.">
<meta property="og:url" content="https://yan7109.github.io/startup-ma.html">
<meta property="og:site_name" content="Derek Z. H. Yan">
<meta property="og:image" content="https://derekyan.com/derek-yan.jpg">
<meta property="article:author" content="Derek Z. H. Yan">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="How to Sell Your Startup: A Founder's Guide to M&A Exits">
<meta name="twitter:description" content="From a founder who led the end-to-end acquisition of his $13.5M-funded startup. 4 years and 100+ conversations.">
<meta name="twitter:image" content="https://derekyan.com/derek-yan.jpg">

<!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "The Toughest Sell: A Founder's Guide to Startup Exits",
  "description": "A practical guide to startup M&A from a founder who led the end-to-end acquisition of his $13.5M-funded company. Learn how to navigate acquisitions, find buyers, negotiate term sheets, and avoid common exit mistakes.",
  "author": {
    "@type": "Person",
    "name": "Derek Z. H. Yan",
    "url": "https://yan7109.github.io",
    "jobTitle": "Director of Engineering",
    "description": "Former CTO of Polarr. Stanford MS. Led end-to-end M&A process through close with Pixieset.",
    "alumniOf": [
      {"@type": "CollegeOrUniversity", "name": "Stanford University"},
      {"@type": "CollegeOrUniversity", "name": "University of Waterloo"}
    ],
    "worksFor": {
      "@type": "Organization",
      "name": "Pixieset"
    }
  },
  "publisher": {
    "@type": "Person",
    "name": "Derek Z. H. Yan"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://yan7109.github.io/startup-ma.html"
  },
  "about": [
    {"@type": "Thing", "name": "Startup M&A"},
    {"@type": "Thing", "name": "Mergers and Acquisitions"},
    {"@type": "Thing", "name": "Startup Exit"},
    {"@type": "Thing", "name": "Selling a Company"},
    {"@type": "Thing", "name": "Term Sheet Negotiation"},
    {"@type": "Thing", "name": "Due Diligence"}
  ],
  "keywords": "startup M&A, how to sell a startup, startup exit, selling your company, founder exit guide, startup acquisition, M&A process, term sheet negotiation, due diligence, acquihire"
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "How long does it take to sell a startup?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "M&A typically takes 12-18 months minimum. Even with strong inbound interest, the process involves multiple conversations, due diligence, negotiations, and closing procedures that extend the timeline significantly."
      }
    },
    {
      "@type": "Question",
      "name": "Should I hire a banker to sell my startup?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Bankers can amplify interest that already exists, but they cannot create it. Consider hiring a banker when you have multiple interested parties and need help managing a competitive process."
      }
    },
    {
      "@type": "Question",
      "name": "What makes a startup attractive to acquirers?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Key factors include proprietary technology, specialized teams with rare expertise, valuable customer relationships, strong brand or market position, and existing business relationships with potential acquirers."
      }
    },
    {
      "@type": "Question",
      "name": "When is the right time to sell a startup?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "The best time to explore M&A is when you have leverage—strong growth, profitable operations, or compelling inbound interest. Selling from a position of desperation rarely leads to good outcomes."
      }
    }
  ]
}
</script>

<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">
<link rel="stylesheet" href="styles.css?v=2">
<link rel="stylesheet" href="nav-styles.css">
</head>

<body>

<div class="container">
  <div id="nav-container"></div>
</div>

<div class="container">

<h1>Startup M&A</h1>

<p>
Companies that go out looking for a buyer almost <em>always</em> never find one. Even those with term sheets rarely close. We had everything going for us, strong inbound interest, enterprise contracts, products used by tens of millions, a technical team... And it still took four years, over a hundred conversations, and a couple of near-death experiences.

I wrote a <a href="ma-book/index.html">book</a> on this whole bloody experience, hopefully to help founders think clearly and not make the same mistakes I did. The stakes are way too high for the slightest errors.
</p>

<!-- M&A Journey Section -->
<div class="journey-section">
<h2>The M&A Journey</h2>
<p class="journey-intro">Eight stages from preparation to closing. Timeline varies widely, some deals close in 3 months, others take years, and each stage fraught with risks.</p>

<div class="journey-timeline">
  <div class="journey-stage journey-start" data-stage="1">
    <div class="journey-node"><span class="journey-icon"></span></div>
    <div class="journey-content">
      <button class="journey-header" aria-expanded="false">
        <span class="journey-title">Preparation</span>
        <span class="journey-desc">Get your house in order</span>
        <span class="journey-chevron"></span>
      </button>
      <div class="journey-details">
        <ul class="journey-items">
          <li>Develop relationships with potential acquirers <a href="ma-book/chapter-14.html" class="journey-chapter-link">Ch. 14</a></li>
          <li>Maintain 12+ months runway <a href="ma-book/chapter-1.html" class="journey-chapter-link">Ch. 1</a></li>
          <li>Clean up cap table <a href="ma-book/chapter-13.html" class="journey-chapter-link">Ch. 13</a></li>
          <li>Prepare audited financials <a href="ma-book/chapter-18.html" class="journey-chapter-link">Ch. 18</a></li>
          <li>Organize data room <a href="ma-book/chapter-18.html" class="journey-chapter-link">Ch. 18</a></li>
          <li>Prepare outreach materials <a href="ma-book/chapter-15.html" class="journey-chapter-link">Ch. 15</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="journey-stage" data-stage="2">
    <div class="journey-node"><span class="journey-number">2</span></div>
    <div class="journey-content">
      <button class="journey-header" aria-expanded="false">
        <span class="journey-title">Activation</span>
        <span class="journey-desc">Start M&A conversations</span>
        <span class="journey-chevron"></span>
      </button>
      <div class="journey-details">
        <ul class="journey-items">
          <li>Respond to inbound interest <a href="ma-book/chapter-21.html" class="journey-chapter-link">Ch. 21</a></li>
          <li>Reach out to target acquirers <a href="ma-book/chapter-23.html" class="journey-chapter-link">Ch. 23</a></li>
          <li>Signal openness to M&A <a href="ma-book/chapter-5.html" class="journey-chapter-link">Ch. 5</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="journey-stage" data-stage="3">
    <div class="journey-node"><span class="journey-number">3</span></div>
    <div class="journey-content">
      <button class="journey-header" aria-expanded="false">
        <span class="journey-title">Discovery</span>
        <span class="journey-desc">Find the right fit</span>
        <span class="journey-chevron"></span>
      </button>
      <div class="journey-details">
        <ul class="journey-items">
          <li>Initial meetings with potential buyers <a href="ma-book/chapter-26.html" class="journey-chapter-link">Ch. 26</a></li>
          <li>Sign NDAs <a href="ma-book/chapter-27.html" class="journey-chapter-link">Ch. 27</a></li>
          <li>Determine strategic fit <a href="ma-book/chapter-27.html" class="journey-chapter-link">Ch. 27</a></li>
          <li>Preliminary due diligence <a href="ma-book/chapter-31.html" class="journey-chapter-link">Ch. 31</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="journey-stage" data-stage="4">
    <div class="journey-node"><span class="journey-number">4</span></div>
    <div class="journey-content">
      <button class="journey-header" aria-expanded="false">
        <span class="journey-title">Term Alignment</span>
        <span class="journey-desc">Agree on the big picture</span>
        <span class="journey-chevron"></span>
      </button>
      <div class="journey-details">
        <ul class="journey-items">
          <li>Discuss deal structure <a href="ma-book/chapter-30.html" class="journey-chapter-link">Ch. 30</a></li>
          <li>Negotiate consideration (cash vs stock) <a href="ma-book/chapter-41.html" class="journey-chapter-link">Ch. 41</a></li>
          <li>Align on retention packages <a href="ma-book/chapter-41.html" class="journey-chapter-link">Ch. 41</a></li>
          <li>Address earnout expectations <a href="ma-book/chapter-41.html" class="journey-chapter-link">Ch. 41</a></li>
          <li>Align internal stakeholders <a href="ma-book/chapter-12.html" class="journey-chapter-link">Ch. 12</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="journey-stage journey-critical" data-stage="5">
    <div class="journey-node"><span class="journey-number">5</span></div>
    <div class="journey-content">
      <button class="journey-header" aria-expanded="false">
        <span class="journey-title">Term Sheet</span>
        <span class="journey-desc">Point of no return</span>
        <span class="journey-chevron"></span>
      </button>
      <div class="journey-details">
        <ul class="journey-items">
          <li>LOI negotiation <a href="ma-book/chapter-42.html" class="journey-chapter-link">Ch. 42</a></li>
          <li>Exclusivity period begins <a href="ma-book/chapter-43.html" class="journey-chapter-link">Ch. 43</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="journey-stage" data-stage="6">
    <div class="journey-node"><span class="journey-number">6</span></div>
    <div class="journey-content">
      <button class="journey-header" aria-expanded="false">
        <span class="journey-title">Due Diligence</span>
        <span class="journey-desc">Everything gets put under a microscope</span>
        <span class="journey-chevron"></span>
      </button>
      <div class="journey-details">
        <ul class="journey-items">
          <li>Full DD (legal, financial, tech, HR) <a href="ma-book/chapter-43.html" class="journey-chapter-link">Ch. 43</a></li>
          <li>Complete disclosure schedules <a href="ma-book/chapter-43.html" class="journey-chapter-link">Ch. 43</a></li>
          <li>Draft definitive agreements <a href="ma-book/chapter-44.html" class="journey-chapter-link">Ch. 44</a></li>
          <li>Key employee interviews <a href="ma-book/chapter-32.html" class="journey-chapter-link">Ch. 32</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="journey-stage" data-stage="7">
    <div class="journey-node"><span class="journey-number">7</span></div>
    <div class="journey-content">
      <button class="journey-header" aria-expanded="false">
        <span class="journey-title">Final Documents</span>
        <span class="journey-desc">Terms become legally binding</span>
        <span class="journey-chevron"></span>
      </button>
      <div class="journey-details">
        <ul class="journey-items">
          <li>Finalize definitive agreements <a href="ma-book/chapter-47.html" class="journey-chapter-link">Ch. 47</a></li>
          <li>Employment contracts <a href="ma-book/chapter-47.html" class="journey-chapter-link">Ch. 47</a></li>
          <li>280G analysis and approvals <a href="ma-book/chapter-45.html" class="journey-chapter-link">Ch. 45</a></li>
          <li>Board and shareholder approvals <a href="ma-book/chapter-48.html" class="journey-chapter-link">Ch. 48</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="journey-stage journey-finish" data-stage="8">
    <div class="journey-node"><span class="journey-icon"></span></div>
    <div class="journey-content">
      <button class="journey-header" aria-expanded="false">
        <span class="journey-title">Closing</span>
        <span class="journey-desc">Cross the finish line</span>
        <span class="journey-chevron"></span>
      </button>
      <div class="journey-details">
        <ul class="journey-items">
          <li>Document execution <a href="ma-book/chapter-50.html" class="journey-chapter-link">Ch. 50</a></li>
          <li>Asset and IP transfer <a href="ma-book/chapter-50.html" class="journey-chapter-link">Ch. 50</a></li>
          <li>Wire funds <a href="ma-book/chapter-50.html" class="journey-chapter-link">Ch. 50</a></li>
          <li>Distribute to shareholders <a href="ma-book/chapter-50.html" class="journey-chapter-link">Ch. 50</a></li>
          <li>Press release <a href="ma-book/chapter-50.html" class="journey-chapter-link">Ch. 50</a></li>
        </ul>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Resources Section -->
<div class="resources-section">
<h2>Resources</h2>
<div class="resources-grid">
  <div class="resource-card">
    <div class="resource-title">M&A Readiness Checklist</div>
    <div class="resource-desc">12 items to check off before engaging with potential buyers. Don't start conversations until you're ready.</div>
    <a href="ma-readiness-checklist.html" class="resource-link">View Checklist</a>
  </div>
  <div class="resource-card">
    <div class="resource-title">Sample Outreach Emails</div>
    <div class="resource-desc">Copy-paste templates for reaching out to potential acquirers, whether you have offers in hand or not.</div>
    <a href="ma-outreach-email.html" class="resource-link">View Templates</a>
  </div>
  <div class="resource-card">
    <div class="resource-title">Outreach Deck Guide</div>
    <div class="resource-desc">How to structure your M&A introduction deck. What to include, what to leave out, and how to invite conversation.</div>
    <a href="ma-outreach-deck.html" class="resource-link">View Guide</a>
  </div>
  <div class="resource-card">
    <div class="resource-title">Data Room Checklist</div>
    <div class="resource-desc">Comprehensive due diligence document list across 16 categories. Have these ready before buyers ask.</div>
    <a href="ma-data-room-checklist.html" class="resource-link">View Checklist</a>
  </div>
  <div class="resource-card resource-card-full">
    <div class="resource-title">The Toughest Sell: A Founder's Guide to Startup Exits</div>
    <div class="resource-desc">A culmination of all the mistakes and learnings from my four-year journey to sell my company. 53 chapters of hard lessons, what worked, what didn't, and how perseverance paid off in the end. Free to read online.</div>
    <a href="ma-book/index.html" class="resource-link">Read the Book</a>
  </div>
</div>
</div>

<!-- Tools Section -->
<div class="tools-section">
<h2>Tools</h2>
<div class="tools-grid">
  <div class="tool-card tool-card-full" id="readiness-test-card">
    <div class="tool-header" id="tool-header" onclick="startQuestionnaire()">
      <div>
        <div class="tool-title">M&A Readiness Test</div>
        <div class="tool-desc">10 questions to understand where you stand and what your realistic path might be.</div>
      </div>
      <button class="tool-start-btn" id="tool-start-btn" onclick="startQuestionnaire()">Take Assessment</button>
    </div>
    <div class="tool-content hidden" id="tool-content">
      <!-- Question Section -->
      <div id="question-section" class="hidden">
        <div class="q-progress">
          <div class="q-progress-bar">
            <div class="q-progress-fill" id="progress-fill"></div>
          </div>
          <div class="q-progress-text" id="progress-text">Question 1 of 10</div>
        </div>

        <div id="question-container">
          <h3 id="question-text"></h3>
          <div id="answers-container"></div>
        </div>

        <button class="q-back-btn hidden" id="back-btn" onclick="goBack()">Back</button>
      </div>

      <!-- Results Section -->
      <div id="results-section" class="hidden">
        <div id="burnout-warning" class="q-warning hidden">
          <strong>A note of caution:</strong> Selling because you're exhausted rarely ends well. M&A is one of the most stressful things you'll ever do—it won't give you the relief you're looking for. Consider whether you can take a break, hire help, or reduce your role instead.
          <br><br>
          <strong>Read:</strong> Chapter 2 - "An Exit is Not the Silver Bullet You've Been Looking for"
        </div>

        <div class="q-result-box">
          <h3 id="result-title"></h3>
          <div id="result-description"></div>

          <div class="q-chapters">
            <strong>Recommended Reading</strong>
            <p class="q-chapters-intro">From <a href="ma-book/index.html">The Toughest Sell</a>, my book on startup M&A:</p>
            <div id="chapters-list"></div>
          </div>
        </div>

        <button class="q-restart-btn" onclick="restartQuestionnaire()">Retake Assessment</button>
      </div>
    </div>
  </div>

  <!-- Valuation & Acquisition Type Estimator -->
  <div class="tool-card tool-card-full" id="valuation-tool-card">
    <div class="tool-header" id="valuation-tool-header" onclick="startValuationAssessment()">
      <div>
        <div class="tool-title">Valuation & Acquisition Type Estimator</div>
        <div class="tool-desc">Understand your likely acquisition type and realistic valuation range.</div>
      </div>
      <button class="tool-start-btn" id="valuation-start-btn" onclick="startValuationAssessment()">Take Assessment</button>
    </div>
    <div class="tool-content hidden" id="valuation-tool-content">
      <!-- Question Section -->
      <div id="valuation-question-section" class="hidden">
        <div class="q-progress">
          <div class="q-progress-bar">
            <div class="q-progress-fill" id="valuation-progress-fill"></div>
          </div>
          <div class="q-progress-text" id="valuation-progress-text">Question 1 of 10</div>
        </div>

        <div id="valuation-question-container">
          <h3 id="valuation-question-text"></h3>
          <div id="valuation-answers-container"></div>
        </div>

        <button class="q-back-btn hidden" id="valuation-back-btn" onclick="valuationGoBack()">Back</button>
      </div>

      <!-- Results Section -->
      <div id="valuation-results-section" class="hidden">
        <div id="valuation-warnings"></div>

        <div class="q-result-box">
          <h3 id="valuation-result-title"></h3>
          <div id="valuation-result-description"></div>

          <div class="valuation-range-box" id="valuation-range-box">
            <div class="valuation-range-label">Estimated Valuation Range</div>
            <div class="valuation-range-value" id="valuation-range-value"></div>
            <div class="valuation-range-note" id="valuation-range-note"></div>
          </div>

          <div class="valuation-factors" id="valuation-factors">
            <strong>Key Factors</strong>
            <div id="valuation-factors-list"></div>
          </div>

          <div class="q-chapters">
            <strong>Recommended Reading</strong>
            <p class="q-chapters-intro">From <a href="ma-book/index.html">The Toughest Sell</a>, my book on startup M&A:</p>
            <div id="valuation-chapters-list"></div>
          </div>
        </div>

        <button class="q-restart-btn" onclick="restartValuationAssessment()">Retake Assessment</button>
      </div>
    </div>
  </div>

  <!-- Vet Your Inbound Assessment -->
  <div class="tool-card tool-card-full" id="inbound-tool-card">
    <div class="tool-header" id="inbound-tool-header" onclick="startInboundAssessment()">
      <div>
        <div class="tool-title">Vet Your Inbound</div>
        <div class="tool-desc">Evaluate whether an acquisition inquiry is real interest or a fishing expedition.</div>
      </div>
      <button class="tool-start-btn" id="inbound-start-btn" onclick="startInboundAssessment()">Take Assessment</button>
    </div>
    <div class="tool-content hidden" id="inbound-tool-content">
      <!-- Question Section -->
      <div id="inbound-question-section" class="hidden">
        <div class="q-progress">
          <div class="q-progress-bar">
            <div class="q-progress-fill" id="inbound-progress-fill"></div>
          </div>
          <div class="q-progress-text" id="inbound-progress-text">Question 1 of 8</div>
        </div>

        <div id="inbound-question-container">
          <h3 id="inbound-question-text"></h3>
          <p id="inbound-question-hint" class="q-hint"></p>
          <div id="inbound-answers-container"></div>
        </div>

        <button class="q-back-btn hidden" id="inbound-back-btn" onclick="inboundGoBack()">Back</button>
      </div>

      <!-- Results Section -->
      <div id="inbound-results-section" class="hidden">
        <div id="inbound-warnings"></div>

        <div class="q-result-box">
          <div class="inbound-signal-badge" id="inbound-signal-badge"></div>
          <h3 id="inbound-result-title"></h3>
          <div id="inbound-result-description"></div>

          <div class="inbound-next-steps" id="inbound-next-steps">
            <strong>Suggested Next Steps</strong>
            <div id="inbound-steps-list"></div>
          </div>

          <div class="q-chapters">
            <strong>Recommended Reading</strong>
            <p class="q-chapters-intro">From <a href="ma-book/index.html">The Toughest Sell</a>, my book on startup M&A:</p>
            <div id="inbound-chapters-list"></div>
          </div>
        </div>

        <button class="q-restart-btn" onclick="restartInboundAssessment()">Evaluate Another Inquiry</button>
      </div>
    </div>
  </div>

  <!-- Do You Need a Banker? Assessment -->
  <div class="tool-card tool-card-full" id="banker-tool-card">
    <div class="tool-header" id="banker-tool-header" onclick="startBankerAssessment()">
      <div>
        <div class="tool-title">Do You Need a Banker?</div>
        <div class="tool-desc">Determine whether hiring an investment banker will help or hurt your M&A process.</div>
      </div>
      <button class="tool-start-btn" id="banker-start-btn" onclick="startBankerAssessment()">Take Assessment</button>
    </div>
    <div class="tool-content hidden" id="banker-tool-content">
      <!-- Question Section -->
      <div id="banker-question-section" class="hidden">
        <div class="q-progress">
          <div class="q-progress-bar">
            <div class="q-progress-fill" id="banker-progress-fill"></div>
          </div>
          <div class="q-progress-text" id="banker-progress-text">Question 1 of 10</div>
        </div>

        <div id="banker-question-container">
          <h3 id="banker-question-text"></h3>
          <p id="banker-question-hint" class="q-hint"></p>
          <div id="banker-answers-container"></div>
        </div>

        <button class="q-back-btn hidden" id="banker-back-btn" onclick="bankerGoBack()">Back</button>
      </div>

      <!-- Results Section -->
      <div id="banker-results-section" class="hidden">
        <div class="q-result-box">
          <h3 id="banker-result-title"></h3>
          <div id="banker-result-description"></div>

          <div class="q-chapters">
            <strong>Recommended Reading</strong>
            <p class="q-chapters-intro">From <a href="ma-book/index.html">The Toughest Sell</a>, my book on startup M&A:</p>
            <div id="banker-chapters-list"></div>
          </div>
        </div>

        <button class="q-restart-btn" onclick="restartBankerAssessment()">Retake Assessment</button>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Connect Section -->
<div class="connect-section">
  <h2>Connect</h2>
  <p>If you read through all the material on this page, and still need help, feel free to reach out.</p>
  <a href="https://calendly.com/yan7109/30min" target="_blank" rel="noopener" class="connect-link">Book a Call</a>
</div>

<footer>
&copy; Derek Z. H. Yan &mdash; views expressed are my own.
</footer>

</div>

<script src="nav-component.js"></script>
<script>
const questions = [
  {
    id: 'runway',
    text: 'How long can your company operate at current burn rate?',
    answers: [
      { value: 'less_than_6_months', label: 'Less than 6 months' },
      { value: '6_to_12_months', label: '6-12 months' },
      { value: '12_to_18_months', label: '12-18 months' },
      { value: 'over_18_months', label: 'More than 18 months (or profitable)' }
    ]
  },
  {
    id: 'interest',
    text: 'Have potential acquirers reached out to you?',
    answers: [
      { value: 'written_offer', label: 'Yes, we have a written offer or term sheet' },
      { value: 'serious_conversations', label: 'Yes, we\'ve had serious conversations with executives' },
      { value: 'exploratory', label: 'We\'ve had exploratory calls but nothing concrete' },
      { value: 'none', label: 'No acquisition interest' }
    ]
  },
  {
    id: 'relationships',
    text: 'Do you have existing business relationships with companies that could acquire you?',
    answers: [
      { value: 'deeply_integrated', label: 'Yes, deeply integrated (partnerships, licensing, distribution)' },
      { value: 'commercial', label: 'Yes, commercial relationships (customer, vendor)' },
      { value: 'know_people', label: 'Know people but no business relationship' },
      { value: 'none', label: 'No relationships with potential acquirers' }
    ]
  },
  {
    id: 'motivation',
    text: 'Why are you considering an exit?',
    answers: [
      { value: 'inbound_interest', label: 'We received compelling inbound interest' },
      { value: 'growth_outpacing', label: 'Growth is outpacing our ability to manage' },
      { value: 'liquidity', label: 'Team and/or investors need liquidity' },
      { value: 'exhausted', label: 'I\'m exhausted and need a change' },
      { value: 'company_failing', label: 'The company is struggling and this is a last resort' }
    ]
  },
  {
    id: 'alignment',
    text: 'How aligned are your cofounders and board on pursuing an exit?',
    answers: [
      { value: 'fully_aligned', label: 'Fully aligned and actively supportive' },
      { value: 'generally_supportive', label: 'Generally supportive with some concerns' },
      { value: 'mixed', label: 'Mixed—some want to sell, others don\'t' },
      { value: 'adversarial', label: 'Significant conflict or adversarial dynamics' }
    ]
  },
  {
    id: 'revenue',
    text: 'What is your company\'s annual recurring revenue?',
    answers: [
      { value: 'under_1m', label: 'Less than $1M' },
      { value: '1m_to_10m', label: '$1M - $10M' },
      { value: '10m_to_50m', label: '$10M - $50M' },
      { value: 'over_50m', label: 'More than $50M' }
    ]
  },
  {
    id: 'growth',
    text: 'How would you describe your company\'s trajectory?',
    answers: [
      { value: 'high_growth', label: 'Growing fast (50%+ YoY) and/or profitable' },
      { value: 'moderate_growth', label: 'Growing moderately (10-50% YoY)' },
      { value: 'flat', label: 'Flat or slow growth' },
      { value: 'declining', label: 'Revenue declining' }
    ]
  },
  {
    id: 'differentiation',
    text: 'What makes your company valuable to a potential acquirer?',
    answers: [
      { value: 'proprietary_tech', label: 'Proprietary technology that\'s hard to replicate' },
      { value: 'specialized_team', label: 'Specialized team with rare expertise' },
      { value: 'customer_relationships', label: 'Valuable customer relationships or contracts' },
      { value: 'brand_position', label: 'Strong brand or market position' },
      { value: 'nothing_unique', label: 'Honestly, nothing that stands out' }
    ]
  },
  {
    id: 'commitment',
    text: 'Would you work at the acquiring company for 2+ years?',
    answers: [
      { value: 'excited', label: 'Yes, I\'d be excited about the right opportunity' },
      { value: 'conditional', label: 'Yes, if the fit and terms are right' },
      { value: 'reluctant', label: 'Only if absolutely required' },
      { value: 'no', label: 'No, I want a clean exit' }
    ]
  },
  {
    id: 'readiness',
    text: 'Are there issues that could complicate a deal?',
    answers: [
      { value: 'clean', label: 'No significant issues—clean cap table, aligned team' },
      { value: 'minor_issues', label: 'Some minor issues we could address' },
      { value: 'remote_issues', label: 'Remote team, messy cap table, or pending issues' },
      { value: 'major_issues', label: 'Litigation, adversarial ex-cofounders, major problems' }
    ]
  }
];

const outcomes = {
  extend_runway: {
    title: 'Extend Your Runway First',
    description: `
      <p>Even if you have an offer in hand, six months is too short to complete an M&A. Your cash position is a huge part of your negotiation leverage. Why would an acquiring company pay a premium when they know it will be worth nothing in a few months?</p>
      <p><strong>Your priority:</strong> Cut costs, increase revenue, or raise a bridge round. Once you have 12+ months runway, revisit M&A.</p>
    `,
    chapters: [
      { num: 1, title: 'Chances Are, It is Already Too Late' },
      { num: 9, title: 'Prepare for the Most Likely Case of No Acceptable Offer' },
      { num: 11, title: 'Get Your Personal Finances in Order' }
    ]
  },
  address_alignment: {
    title: 'Address Internal Alignment First',
    description: `
      <p>M&A will amplify every crack in your relationships with cofounders and board members. Misalignment here will torpedo deals—buyers can sense it.</p>
      <p><strong>Your priority:</strong> Have the hard conversations now. Align on expectations, retention split, and what "acceptable" looks like before engaging with buyers.</p>
    `,
    chapters: [
      { num: 6, title: 'Know Thyself' },
      { num: 12, title: 'Herding Cats: Aligning Spouses, Cofounders, Investors, and Employees' },
      { num: 38, title: 'Managing Stakeholders When You Can\'t Sell' }
    ]
  },
  build_relationships: {
    title: 'Focus on Building Relationships',
    description: `
      <p>Companies are bought, not sold. Without existing relationships with potential acquirers, cold outreach rarely works. The good news: you have time to build these.</p>
      <p><strong>Your priority:</strong> Build partnerships, stay visible, and plant seeds. Every potential acquirer should know who you are before you need them to buy you.</p>
    `,
    chapters: [
      { num: 5, title: 'Manufacturing an M&A Market When None is There' },
      { num: 14, title: 'Come Up with an Outreach List of Potential Acquirers' },
      { num: 23, title: 'Activate Outbound, Plant the Seed' }
    ]
  },
  strong_position: {
    title: 'You\'re in a Strong Position—M&A is Optional',
    description: `
      <p>You have leverage most founders dream of. M&A is just one option—you could also raise at favorable terms, hire professional management, or keep building.</p>
      <p><strong>Consider:</strong> Is selling actually what you want? You're not in a position where you need to sell, so make sure the motivation is right.</p>
    `,
    chapters: [
      { num: 4, title: 'Caught Off Guard: Handling M&A Inquiries Before You\'re Ready' },
      { num: 6, title: 'Know Thyself' },
      { num: 7, title: 'Sell for the Right Reasons' }
    ]
  },
  engage_carefully: {
    title: 'You Have Actionable Interest—Engage Carefully',
    description: `
      <p>This is the strongest position to be in. With actionable interest, you have leverage to run a proper process and discover your true market value.</p>
      <p><strong>Your priority:</strong> Don't take the first offer. Inform your board, reach out to other potential acquirers, and consider hiring a banker to manage the process.</p>
    `,
    chapters: [
      { num: 16, title: 'Should You Hire a Banker?' },
      { num: 21, title: 'Engage Inbound, Lean In and Learn' },
      { num: 22, title: 'The Inside View from an Inbound Reach Out' }
    ]
  },
  prepare_house: {
    title: 'Prepare Your House Before Engaging',
    description: `
      <p>You have market access, but issues with your company could derail deals or hurt your valuation. Buyers can smell dysfunction.</p>
      <p><strong>Your priority:</strong> Clean up before engaging seriously. Address cap table issues, resolve any personnel problems, and get your data room in order.</p>
    `,
    chapters: [
      { num: 13, title: 'Paint the Walls: Nobody Buys a Fixer-Upper' },
      { num: 18, title: 'Get Your (Data) Room in Order' },
      { num: 19, title: 'Checklist Before Engaging with Potential Buyers' }
    ]
  },
  long_road: {
    title: 'Prepare for a Long Road',
    description: `
      <p>M&A is possible for you, but it won't be quick or easy. The average process takes 1-2 years with many false starts.</p>
      <p><strong>Your priority:</strong> Rewire your expectations. Assume no deal will happen and build accordingly. Keep the business running while you explore—most deals fall through.</p>
    `,
    chapters: [
      { num: 8, title: 'Rewire Your Brain: Getting Into Exit Mode' },
      { num: 9, title: 'Prepare for the Most Likely Case of No Acceptable Offer' },
      { num: 20, title: 'Don\'t Forget You Still Have a Company to Run' }
    ]
  },
  consider_alternatives: {
    title: 'Consider Alternatives to M&A',
    description: `
      <p>Given your situation, finding a buyer will be extremely difficult. This isn't failure—it's just the reality of the M&A market.</p>
      <p><strong>Your options:</strong></p>
      <ul>
        <li>Wind down gracefully and return remaining cash to investors</li>
        <li>Pivot to something with more traction</li>
        <li>Run as a lifestyle business if profitable</li>
      </ul>
    `,
    chapters: [
      { num: 6, title: 'Know Thyself' },
      { num: 35, title: 'It\'s Not You, Not Your Bankers, Not Your Board, It\'s the Market' },
      { num: 40, title: 'It\'s Okay to Shut it All Down, But Do it On Your Own Terms' }
    ]
  }
};

let currentQuestion = 0;
let answers = {};

function startQuestionnaire() {
  document.getElementById('tool-start-btn').classList.add('hidden');
  document.getElementById('tool-content').classList.remove('hidden');
  document.getElementById('question-section').classList.remove('hidden');
  showQuestion(0);
}

function showQuestion(index) {
  currentQuestion = index;
  const question = questions[index];

  document.getElementById('progress-fill').style.width = ((index + 1) / questions.length * 100) + '%';
  document.getElementById('progress-text').textContent = `Question ${index + 1} of ${questions.length}`;
  document.getElementById('question-text').textContent = question.text;

  const container = document.getElementById('answers-container');
  container.innerHTML = '';

  question.answers.forEach(answer => {
    const btn = document.createElement('button');
    btn.className = 'q-answer-btn' + (answers[question.id] === answer.value ? ' selected' : '');
    btn.textContent = answer.label;
    btn.onclick = function() { selectAnswer(question.id, answer.value, this); };
    container.appendChild(btn);
  });

  document.getElementById('back-btn').classList.toggle('hidden', index === 0);
}

function selectAnswer(questionId, value, element) {
  answers[questionId] = value;
  document.querySelectorAll('.q-answer-btn').forEach(btn => btn.classList.remove('selected'));
  element.classList.add('selected');

  setTimeout(() => {
    // Check for early termination conditions
    const earlyOutcome = checkEarlyTermination();
    if (earlyOutcome) {
      showResults(earlyOutcome);
    } else if (currentQuestion < questions.length - 1) {
      showQuestion(currentQuestion + 1);
    } else {
      showResults();
    }
  }, 200);
}

function checkEarlyTermination() {
  // After Q1 (runway): if < 6 months, terminate immediately
  if (answers.runway === 'less_than_6_months') {
    return 'extend_runway';
  }

  // After Q4 (motivation): if company failing + not long runway, terminate
  if (answers.motivation === 'company_failing' &&
      answers.runway && answers.runway !== 'over_18_months') {
    return 'consider_alternatives';
  }

  // After Q5 (alignment): if adversarial, terminate
  if (answers.alignment === 'adversarial') {
    return 'address_alignment';
  }

  return null;
}

function goBack() {
  if (currentQuestion > 0) showQuestion(currentQuestion - 1);
}

function calculateOutcome(answers) {
  // Early termination cases (also handled by checkEarlyTermination for skipping)
  if (answers.runway === 'less_than_6_months') return 'extend_runway';
  if (answers.alignment === 'adversarial') return 'address_alignment';
  if (answers.motivation === 'company_failing' && answers.runway !== 'over_18_months') return 'consider_alternatives';

  const hasActionableOffer = answers.interest === 'written_offer';
  const hasInterest = ['written_offer', 'serious_conversations'].includes(answers.interest);
  const hasRelationships = ['deeply_integrated', 'commercial'].includes(answers.relationships);
  const isStrong = answers.growth === 'high_growth' && answers.runway === 'over_18_months';

  if (hasActionableOffer && answers.readiness !== 'major_issues') return 'engage_carefully';
  if (!hasInterest && !hasRelationships) return isStrong ? 'strong_position' : 'build_relationships';
  if (isStrong && !hasInterest) return 'strong_position';
  if ((hasInterest || hasRelationships) && ['remote_issues', 'major_issues'].includes(answers.readiness)) return 'prepare_house';
  if (answers.growth === 'declining' && answers.differentiation === 'nothing_unique') return 'consider_alternatives';

  return 'long_road';
}

function showResults(earlyOutcome) {
  document.getElementById('question-section').classList.add('hidden');
  document.getElementById('results-section').classList.remove('hidden');

  const outcomeKey = earlyOutcome || calculateOutcome(answers);
  const outcome = outcomes[outcomeKey];

  if (answers.motivation === 'exhausted') {
    document.getElementById('burnout-warning').classList.remove('hidden');
  }

  document.getElementById('result-title').textContent = outcome.title;
  document.getElementById('result-description').innerHTML = outcome.description;

  const chaptersList = document.getElementById('chapters-list');
  chaptersList.innerHTML = '';
  outcome.chapters.forEach(ch => {
    const div = document.createElement('div');
    div.className = 'q-chapter-item';
    div.innerHTML = `<a href="ma-book/chapter-${ch.num}.html" class="q-chapter-link"><span class="q-chapter-num">Ch. ${ch.num}</span> ${ch.title}</a>`;
    chaptersList.appendChild(div);
  });
}

function restartQuestionnaire() {
  answers = {};
  currentQuestion = 0;
  document.getElementById('results-section').classList.add('hidden');
  document.getElementById('burnout-warning').classList.add('hidden');
  document.getElementById('question-section').classList.add('hidden');
  document.getElementById('tool-content').classList.add('hidden');
  document.getElementById('tool-start-btn').classList.remove('hidden');
}

// ==========================================
// VALUATION & ACQUISITION TYPE ESTIMATOR
// ==========================================

const valuationQuestions = [
  {
    id: 'arr',
    text: 'What is your Annual Recurring Revenue (ARR)?',
    answers: [
      { value: 'pre_revenue', label: 'Pre-revenue or less than $500K' },
      { value: 'arr_500k_2m', label: '$500K - $2M' },
      { value: 'arr_2m_5m', label: '$2M - $5M' },
      { value: 'arr_5m_10m', label: '$5M - $10M' },
      { value: 'arr_10m_50m', label: '$10M - $50M' },
      { value: 'arr_over_50m', label: 'More than $50M' }
    ]
  },
  {
    id: 'business_type',
    text: 'What type of business are you building?',
    answers: [
      { value: 'deep_tech', label: 'Deep tech (AI/ML, robotics, biotech, quantum, aerospace)' },
      { value: 'enterprise_saas', label: 'Enterprise SaaS or B2B software' },
      { value: 'consumer', label: 'Consumer app or marketplace' },
      { value: 'services', label: 'Services, agency, or consulting' },
      { value: 'hardware', label: 'Hardware or physical products' },
      { value: 'other', label: 'Other' }
    ]
  },
  {
    id: 'growth',
    text: 'What is your revenue growth rate (year-over-year)?',
    // Skip for pre-revenue companies
    condition: (answers) => answers.arr !== 'pre_revenue',
    answers: [
      { value: 'declining', label: 'Declining (negative growth)' },
      { value: 'flat', label: 'Flat (0-10%)' },
      { value: 'moderate', label: 'Moderate (10-30%)' },
      { value: 'strong', label: 'Strong (30-50%)' },
      { value: 'hypergrowth', label: 'Hypergrowth (50-100%)' },
      { value: 'exceptional', label: 'Exceptional (100%+)' }
    ]
  },
  {
    id: 'capital_raised',
    text: 'How much total capital have you raised to date?',
    answers: [
      { value: 'bootstrapped', label: 'Bootstrapped / less than $1M' },
      { value: 'seed', label: '$1M - $5M (Seed)' },
      { value: 'series_a', label: '$5M - $15M (Series A)' },
      { value: 'series_b', label: '$15M - $40M (Series B)' },
      { value: 'series_c_plus', label: 'More than $40M (Series C+)' }
    ]
  },
  {
    id: 'last_fundraise',
    text: 'When did you last raise funding?',
    // Skip for bootstrapped companies
    condition: (answers) => answers.capital_raised !== 'bootstrapped',
    answers: [
      { value: 'fundraise_under_12m', label: 'Less than 12 months ago' },
      { value: 'fundraise_12_24m', label: '12-24 months ago' },
      { value: 'fundraise_24_36m', label: '2-3 years ago' },
      { value: 'fundraise_over_36m', label: 'More than 3 years ago' }
    ]
  },
  {
    id: 'last_valuation',
    text: 'What was your valuation at the last round?',
    // Skip for bootstrapped companies
    condition: (answers) => answers.capital_raised !== 'bootstrapped',
    answers: [
      { value: 'val_under_10m', label: 'Less than $10M' },
      { value: 'val_10m_30m', label: '$10M - $30M' },
      { value: 'val_30m_75m', label: '$30M - $75M' },
      { value: 'val_75m_150m', label: '$75M - $150M' },
      { value: 'val_over_150m', label: 'More than $150M' }
    ]
  },
  {
    id: 'performance_since_raise',
    text: 'How has your business performed since your last fundraise?',
    // Skip for bootstrapped or very recent raises (not enough time to measure)
    condition: (answers) => answers.capital_raised !== 'bootstrapped' && answers.last_fundraise !== 'fundraise_under_12m',
    answers: [
      { value: 'perf_declined_significantly', label: 'Declined significantly (revenue down 30%+)' },
      { value: 'perf_declined_somewhat', label: 'Declined somewhat (revenue down 10-30%)' },
      { value: 'perf_flat', label: 'Roughly flat (within +/- 10%)' },
      { value: 'perf_grew_moderately', label: 'Grew moderately (up 10-50%)' },
      { value: 'perf_grew_significantly', label: 'Grew significantly (up 50-100%)' },
      { value: 'perf_doubled_plus', label: 'More than doubled (100%+)' }
    ]
  },
  {
    id: 'liq_pref',
    text: 'What is your liquidation preference structure?',
    // Skip for bootstrapped companies
    condition: (answers) => answers.capital_raised !== 'bootstrapped',
    answers: [
      { value: 'liq_1x_non_part', label: '1x non-participating (founder-friendly)' },
      { value: 'liq_1x_part', label: '1x participating' },
      { value: 'liq_2x_plus', label: '2x+ or stacked preferences' },
      { value: 'liq_complex', label: 'Complex/multiple classes with different terms' },
      { value: 'liq_unsure', label: "I'm not sure" }
    ]
  },
  {
    id: 'gross_margin',
    text: 'What is your gross margin?',
    // Skip for pre-revenue companies
    condition: (answers) => answers.arr !== 'pre_revenue',
    answers: [
      { value: 'margin_below_40', label: 'Below 40% (hardware/services-heavy)' },
      { value: 'margin_40_60', label: '40-60% (mixed model)' },
      { value: 'margin_60_75', label: '60-75% (typical SaaS)' },
      { value: 'margin_above_75', label: 'Above 75% (high-margin SaaS/software)' }
    ]
  },
  {
    id: 'ebitda',
    text: 'What is your EBITDA / profitability status?',
    answers: [
      { value: 'burn_high', label: 'Burning more than $500K/month' },
      { value: 'burn_low', label: 'Burning less than $500K/month' },
      { value: 'breakeven', label: 'Break-even' },
      { value: 'ebitda_500k_2m', label: '$500K - $2M annual EBITDA' },
      { value: 'ebitda_2m_5m', label: '$2M - $5M annual EBITDA' },
      { value: 'ebitda_over_5m', label: 'More than $5M annual EBITDA' }
    ]
  },
  {
    id: 'key_talent',
    text: 'How many key technical people (engineers/researchers) do you have?',
    answers: [
      { value: 'talent_1_3', label: '1-3 key technical people' },
      { value: 'talent_4_7', label: '4-7 key technical people' },
      { value: 'talent_8_15', label: '8-15 key technical people' },
      { value: 'talent_15_plus', label: '15+ key technical people' }
    ]
  },
  {
    id: 'founder_commitment',
    text: 'Would you and other key people stay at the acquiring company for 2+ years?',
    answers: [
      { value: 'commit_excited', label: 'Yes, excited about the right opportunity' },
      { value: 'commit_willing', label: 'Yes, if the terms and fit are right' },
      { value: 'commit_reluctant', label: 'Only if required for the deal' },
      { value: 'commit_no', label: 'No, we want a clean exit' }
    ]
  },
  {
    id: 'buyer_relationships',
    text: 'Do you have existing business relationships with potential acquirers?',
    answers: [
      { value: 'rel_deep_partnership', label: 'Yes, deep partnership or integration' },
      { value: 'rel_customer_vendor', label: 'Yes, customer or vendor relationship' },
      { value: 'rel_know_people', label: 'Know people but no business relationship' },
      { value: 'rel_none', label: 'No existing relationships' }
    ]
  },
  {
    id: 'customer_concentration',
    text: 'How concentrated is your customer base?',
    // Skip for pre-revenue companies
    condition: (answers) => answers.arr !== 'pre_revenue',
    answers: [
      { value: 'conc_top_50', label: 'Top customer is > 50% of revenue' },
      { value: 'conc_top3_50', label: 'Top 3 customers are > 50% of revenue' },
      { value: 'conc_diversified', label: 'Diversified (no customer > 20%)' },
      { value: 'conc_highly_diversified', label: 'Highly diversified (hundreds/thousands of customers)' }
    ]
  },
  {
    id: 'comparables',
    text: 'What comparable exits have occurred in your space (last 2 years)?',
    answers: [
      { value: 'comp_shutdowns', label: 'Mostly shutdowns or fire sales' },
      { value: 'comp_acquihires', label: 'Mix of acquihires and small exits' },
      { value: 'comp_10m_50m', label: 'Several $10-50M exits' },
      { value: 'comp_notable_50m', label: 'Notable $50M+ strategic exits' },
      { value: 'comp_major_100m', label: 'Major exits ($100M+) in the space' }
    ]
  },
  {
    id: 'value_driver',
    text: 'What would a buyer most want from you?',
    answers: [
      { value: 'driver_team', label: 'Our team/talent (acquihire)' },
      { value: 'driver_ip', label: 'Specific technology or IP (asset)' },
      { value: 'driver_revenue', label: 'Revenue and customer base (PE/financial)' },
      { value: 'driver_strategic', label: 'Strategic fit with their roadmap (strategic)' },
      { value: 'driver_unsure', label: "Honestly, not sure what they'd want" }
    ]
  }
];

// Early exit scenarios - checked after each answer
function checkValuationEarlyExit(answers) {
  const capitalRaised = getCapitalRaised(answers.capital_raised);
  const arrValue = getArrValue(answers.arr);
  const lastValuation = getLastValuation(answers.last_valuation);
  const isDeepTech = answers.business_type === 'deep_tech';

  // Scenario 1: Pre-revenue + raised significant capital ($10M+) + NOT deep tech
  // This is a challenging acquihire scenario - skip ahead
  // Deep tech companies are excluded because they often require massive capital before revenue
  // and can still command strategic acquisitions for their technology
  if (answers.arr === 'pre_revenue' && answers.capital_raised &&
      ['series_a', 'series_b', 'series_c_plus'].includes(answers.capital_raised) &&
      !isDeepTech) {
    return 'early_acquihire_difficult';
  }

  // Scenario 2: Declining revenue significantly + raised significant capital
  // This is heading toward a distressed asset sale
  if (answers.growth === 'declining' && capitalRaised >= 5000000) {
    return 'early_asset_sale_distressed';
  }

  // Scenario 3: Recent raise at high valuation + performance declined significantly
  // Reality check needed - very difficult exit
  // Deep tech excluded - valuation may be based on technology milestones, not ARR
  if (answers.last_fundraise === 'fundraise_under_12m' &&
      ['val_75m_150m', 'val_over_150m'].includes(answers.last_valuation) &&
      answers.arr && arrValue < lastValuation * 0.15 && !isDeepTech) {
    return 'early_valuation_mismatch';
  }

  // Scenario 4: Raised at high valuation but business has declined significantly since
  if (answers.performance_since_raise &&
      ['perf_declined_significantly', 'perf_declined_somewhat'].includes(answers.performance_since_raise) &&
      lastValuation >= 30000000) {
    return 'early_down_round_territory';
  }

  return null;
}

// Additional early exit outcomes
const valuationEarlyOutcomes = {
  early_acquihire_difficult: {
    title: 'Challenging Acquihire Scenario',
    description: `
      <p>You're pre-revenue but have raised significant venture capital. This creates a difficult dynamic: <strong>the math for a traditional acquihire doesn't work</strong> when investors have liquidation preferences in the tens of millions.</p>
      <p>Acquirers typically pay $1-3M per key engineer. Even with a strong team, this rarely covers investor preferences, meaning common shareholders (including founders) may receive little to nothing.</p>
      <p><strong>Your realistic options:</strong></p>
      <ul>
        <li>Negotiate with investors to reduce preferences in exchange for any return</li>
        <li>Focus on building revenue before pursuing M&A</li>
        <li>Accept that this may be a "soft landing" where the team gets jobs but investors write down</li>
      </ul>
    `,
    chapters: [
      { num: 10, title: 'Valuation Fantasies and the Art of Disappointment' },
      { num: 30, title: 'The $$$ Expectation Alignment Conversation' },
      { num: 40, title: "It's Okay to Shut it All Down" }
    ]
  },
  early_asset_sale_distressed: {
    title: 'Distressed Asset Sale Likely',
    description: `
      <p>With declining revenue and significant capital raised, you're likely heading toward a <strong>distressed asset sale</strong>—the corporate equivalent of a clearance sale.</p>
      <p>Buyers will cherry-pick your most valuable assets (IP, key customers, specific technology) while leaving behind the liabilities. The price will almost certainly be below your liquidation preferences.</p>
      <p><strong>What to do now:</strong></p>
      <ul>
        <li>Identify your most valuable assets and find buyers who specifically need them</li>
        <li>Have honest conversations with investors about likely returns</li>
        <li>Consider whether winding down gracefully is a better option than a fire sale</li>
      </ul>
    `,
    chapters: [
      { num: 10, title: 'Valuation Fantasies and the Art of Disappointment' },
      { num: 35, title: "It's Not You, Not Your Bankers, Not Your Board, It's the Market" },
      { num: 40, title: "It's Okay to Shut it All Down" }
    ]
  },
  early_valuation_mismatch: {
    title: 'Severe Valuation Mismatch',
    description: `
      <p>You recently raised at a high valuation, but your current ARR suggests the market may have shifted significantly. <strong>Your last round valuation likely doesn't reflect current market reality.</strong></p>
      <p>Buyers will value you based on your current metrics, not your last round. This creates a painful gap between investor expectations and what the market will pay.</p>
      <p><strong>Before pursuing M&A:</strong></p>
      <ul>
        <li>Have a frank conversation with your board about realistic exit values</li>
        <li>Consider whether extending runway and growing is better than exiting now</li>
        <li>Understand that any exit will likely require investor write-downs</li>
      </ul>
    `,
    chapters: [
      { num: 10, title: 'Valuation Fantasies and the Art of Disappointment' },
      { num: 12, title: 'Herding Cats: Aligning Spouses, Cofounders, Investors, and Employees' },
      { num: 38, title: "Managing Stakeholders When You Can't Sell" }
    ]
  },
  early_down_round_territory: {
    title: 'Down Round Territory',
    description: `
      <p>Your business has declined since your last raise at a significant valuation. This puts you firmly in <strong>down round territory</strong>—where any exit or new funding will be below your last valuation.</p>
      <p>This isn't necessarily fatal, but it requires recalibrating expectations across all stakeholders. The psychological impact of a down round often exceeds the financial impact.</p>
      <p><strong>Key considerations:</strong></p>
      <ul>
        <li>Focus on stabilizing the business before pursuing M&A</li>
        <li>Understand that buyers will negotiate aggressively knowing your position</li>
        <li>Consider whether new investors or a bridge round could help rebuild leverage</li>
      </ul>
    `,
    chapters: [
      { num: 10, title: 'Valuation Fantasies and the Art of Disappointment' },
      { num: 9, title: 'Prepare for the Most Likely Case of No Acceptable Offer' },
      { num: 38, title: "Managing Stakeholders When You Can't Sell" }
    ]
  }
};

function getLastValuation(valAnswer) {
  const valMap = {
    'val_under_10m': 5000000,
    'val_10m_30m': 20000000,
    'val_30m_75m': 52500000,
    'val_75m_150m': 112500000,
    'val_over_150m': 200000000
  };
  return valMap[valAnswer] || 0;
}

const valuationOutcomes = {
  acquihire: {
    title: 'Acquihire',
    description: `
      <p>Your most likely acquisition type is an <strong>acquihire</strong>—where a buyer is primarily interested in acquiring your team rather than your business.</p>
      <p>In an acquihire, most of the compensation comes as <em>retention bonuses</em>, not up-front cash. Expect 70-90% of the deal value to be tied to key employees staying at the acquirer for 2+ years.</p>
      <p><strong>What this means for you:</strong> The deal will be structured around keeping your key people. Your leverage is your team's willingness to stay and their market value.</p>
    `,
    chapters: [
      { num: 10, title: 'Valuation Fantasies and the Art of Disappointment' },
      { num: 32, title: 'Key Employee Interviews' },
      { num: 30, title: 'The $$$ Expectation Alignment Conversation' }
    ]
  },
  asset_sale: {
    title: 'Asset Sale',
    description: `
      <p>Your most likely outcome is an <strong>asset sale</strong>—the corporate equivalent of a clearance sale where buyers pick specific pieces (IP, patents, customers) rather than acquiring the whole business.</p>
      <p>Asset sales typically happen when the business is struggling but has valuable components. Prices are often below liquidation preferences, meaning common shareholders may receive little to nothing.</p>
      <p><strong>What this means for you:</strong> Focus on identifying and highlighting your most valuable assets. Be prepared for difficult conversations with investors about returns.</p>
    `,
    chapters: [
      { num: 10, title: 'Valuation Fantasies and the Art of Disappointment' },
      { num: 40, title: "It's Okay to Shut it All Down" },
      { num: 35, title: "It's Not You, Not Your Bankers, Not Your Board, It's the Market" }
    ]
  },
  revenue_multiple: {
    title: 'Revenue Multiple (PE)',
    description: `
      <p>You're positioned for a <strong>revenue multiple</strong> acquisition—typically from PE buyers or strategic acquirers who value predictable cash flows.</p>
      <p>These deals are grounded in math: ARR, EBITDA, and growth predictability determine your multiple. Buyers look for sustainable unit economics and defensible market position.</p>
      <p><strong>What this means for you:</strong> Get your financials audit-ready. PE buyers will scrutinize every line item. The cleaner your books and more predictable your growth, the higher your multiple.</p>
    `,
    chapters: [
      { num: 10, title: 'Valuation Fantasies and the Art of Disappointment' },
      { num: 16, title: 'Should You Hire a Banker?' },
      { num: 31, title: 'Initial Due Diligence' }
    ]
  },
  strategic: {
    title: 'Strategic Acquisition',
    description: `
      <p>You may be positioned for a <strong>strategic acquisition</strong>—the dream scenario where valuation is driven by narrative, not just math.</p>
      <p>Strategic deals happen when you have something unique that a larger company needs for their roadmap. These can't be engineered—they emerge from strong market position, unique differentiation, and often competitive dynamics among potential buyers.</p>
      <p><strong>What this means for you:</strong> Don't optimize for one buyer. Your leverage comes from having multiple interested parties. Focus on building genuine relationships with potential acquirers before you need them.</p>
    `,
    chapters: [
      { num: 10, title: 'Valuation Fantasies and the Art of Disappointment' },
      { num: 5, title: "Manufacturing an M&A Market When None is There" },
      { num: 21, title: 'Engage Inbound, Lean In and Learn' }
    ]
  }
};

let valuationCurrentQuestion = 0;
let valuationAnswers = {};
let valuationQuestionHistory = []; // Track which questions were shown for back navigation

function startValuationAssessment() {
  document.getElementById('valuation-start-btn').classList.add('hidden');
  document.getElementById('valuation-tool-content').classList.remove('hidden');
  document.getElementById('valuation-question-section').classList.remove('hidden');
  valuationQuestionHistory = [];
  showValuationQuestion(0);
}

// Find the next applicable question (skipping conditional ones that don't apply)
function getNextValuationQuestion(fromIndex) {
  for (let i = fromIndex + 1; i < valuationQuestions.length; i++) {
    const question = valuationQuestions[i];
    // If no condition or condition is met, this is the next question
    if (!question.condition || question.condition(valuationAnswers)) {
      return i;
    }
  }
  return -1; // No more questions
}

// Count how many questions will be shown based on current answers
function countApplicableQuestions() {
  let count = 0;
  for (let i = 0; i < valuationQuestions.length; i++) {
    const question = valuationQuestions[i];
    if (!question.condition || question.condition(valuationAnswers)) {
      count++;
    }
  }
  return count;
}

// Get the position of current question among applicable questions
function getCurrentQuestionPosition() {
  let position = 0;
  for (let i = 0; i <= valuationCurrentQuestion; i++) {
    const question = valuationQuestions[i];
    if (!question.condition || question.condition(valuationAnswers)) {
      position++;
    }
  }
  return position;
}

function showValuationQuestion(index) {
  valuationCurrentQuestion = index;
  const question = valuationQuestions[index];

  // Calculate progress based on applicable questions
  const totalQuestions = countApplicableQuestions();
  const currentPosition = getCurrentQuestionPosition();

  document.getElementById('valuation-progress-fill').style.width = (currentPosition / totalQuestions * 100) + '%';
  document.getElementById('valuation-progress-text').textContent = `Question ${currentPosition} of ${totalQuestions}`;
  document.getElementById('valuation-question-text').textContent = question.text;

  const container = document.getElementById('valuation-answers-container');
  container.innerHTML = '';

  question.answers.forEach(answer => {
    const btn = document.createElement('button');
    btn.className = 'q-answer-btn' + (valuationAnswers[question.id] === answer.value ? ' selected' : '');
    btn.textContent = answer.label;
    btn.onclick = function() { selectValuationAnswer(question.id, answer.value, this); };
    container.appendChild(btn);
  });

  document.getElementById('valuation-back-btn').classList.toggle('hidden', valuationQuestionHistory.length === 0);
}

function selectValuationAnswer(questionId, value, element) {
  valuationAnswers[questionId] = value;
  document.querySelectorAll('#valuation-answers-container .q-answer-btn').forEach(btn => btn.classList.remove('selected'));
  element.classList.add('selected');

  setTimeout(() => {
    // Check for early exit conditions
    const earlyExit = checkValuationEarlyExit(valuationAnswers);
    if (earlyExit) {
      showValuationEarlyResults(earlyExit);
      return;
    }

    // Find next applicable question
    const nextIndex = getNextValuationQuestion(valuationCurrentQuestion);

    if (nextIndex !== -1) {
      valuationQuestionHistory.push(valuationCurrentQuestion);
      showValuationQuestion(nextIndex);
    } else {
      showValuationResults();
    }
  }, 200);
}

function valuationGoBack() {
  if (valuationQuestionHistory.length > 0) {
    const prevIndex = valuationQuestionHistory.pop();
    showValuationQuestion(prevIndex);
  }
}

function showValuationEarlyResults(earlyOutcomeKey) {
  document.getElementById('valuation-question-section').classList.add('hidden');
  document.getElementById('valuation-results-section').classList.remove('hidden');

  const outcome = valuationEarlyOutcomes[earlyOutcomeKey];

  // Clear warnings for early exits (the outcome itself is the warning)
  document.getElementById('valuation-warnings').innerHTML = '';

  // Display title and description
  document.getElementById('valuation-result-title').textContent = outcome.title;
  document.getElementById('valuation-result-description').innerHTML = outcome.description;

  // Hide valuation range for early exits (not enough data for accurate estimate)
  document.getElementById('valuation-range-box').style.display = 'none';

  // Hide factors for early exits
  document.getElementById('valuation-factors').style.display = 'none';

  // Display chapters
  const chaptersList = document.getElementById('valuation-chapters-list');
  chaptersList.innerHTML = '';
  outcome.chapters.forEach(ch => {
    const div = document.createElement('div');
    div.className = 'q-chapter-item';
    div.innerHTML = `<a href="ma-book/chapter-${ch.num}.html" class="q-chapter-link"><span class="q-chapter-num">Ch. ${ch.num}</span> ${ch.title}</a>`;
    chaptersList.appendChild(div);
  });
}

// Helper functions for valuation calculation
function getArrValue(arrAnswer) {
  const arrMap = {
    'pre_revenue': 250000,
    'arr_500k_2m': 1250000,
    'arr_2m_5m': 3500000,
    'arr_5m_10m': 7500000,
    'arr_10m_50m': 30000000,
    'arr_over_50m': 75000000
  };
  return arrMap[arrAnswer] || 0;
}

function getCapitalRaised(capitalAnswer) {
  const capitalMap = {
    'bootstrapped': 500000,
    'seed': 3000000,
    'series_a': 10000000,
    'series_b': 27500000,
    'series_c_plus': 60000000
  };
  return capitalMap[capitalAnswer] || 0;
}

function getKeyPeopleCount(talentAnswer) {
  const talentMap = {
    'talent_1_3': 2,
    'talent_4_7': 5.5,
    'talent_8_15': 11.5,
    'talent_15_plus': 20
  };
  return talentMap[talentAnswer] || 2;
}

function getGrowthMultiplier(growthAnswer) {
  const growthMap = {
    'declining': 0,
    'flat': 0.2,
    'moderate': 0.5,
    'strong': 0.8,
    'hypergrowth': 1.2,
    'exceptional': 1.5
  };
  return growthMap[growthAnswer] || 0.5;
}

function getMarginMultiplier(marginAnswer) {
  const marginMap = {
    'margin_below_40': 0,
    'margin_40_60': 0.3,
    'margin_60_75': 0.7,
    'margin_above_75': 1
  };
  return marginMap[marginAnswer] || 0.5;
}

function calculateValuationType(answers) {
  const arrValue = getArrValue(answers.arr);
  const capitalRaised = getCapitalRaised(answers.capital_raised);
  const lastValuation = getLastValuation(answers.last_valuation);
  const hasEBITDA = ['ebitda_500k_2m', 'ebitda_2m_5m', 'ebitda_over_5m'].includes(answers.ebitda);
  const hasStrongEBITDA = ['ebitda_2m_5m', 'ebitda_over_5m'].includes(answers.ebitda);
  const isHighGrowth = ['strong', 'hypergrowth', 'exceptional'].includes(answers.growth);
  const isExceptionalGrowth = ['hypergrowth', 'exceptional'].includes(answers.growth);
  const isFlat = ['declining', 'flat'].includes(answers.growth);
  const isBootstrapped = answers.capital_raised === 'bootstrapped';
  const hasHighMargins = ['margin_60_75', 'margin_above_75'].includes(answers.gross_margin);
  const selfAssessment = answers.value_driver;
  const marketContext = answers.comparables;

  // New question signals
  const isDeepTech = answers.business_type === 'deep_tech';
  const hasDeepBuyerRelationship = answers.buyer_relationships === 'rel_deep_partnership';
  const hasBuyerRelationship = ['rel_deep_partnership', 'rel_customer_vendor'].includes(answers.buyer_relationships);
  const founderWillStay = ['commit_excited', 'commit_willing'].includes(answers.founder_commitment);
  const founderWontStay = answers.founder_commitment === 'commit_no';

  // Check for performance decline since last raise
  const hasDeclinedSinceRaise = ['perf_declined_significantly', 'perf_declined_somewhat', 'perf_flat'].includes(answers.performance_since_raise);
  const hasGrownSinceRaise = ['perf_grew_significantly', 'perf_doubled_plus'].includes(answers.performance_since_raise);

  // Strategic Path 1: Self-identifies as strategic + good market + meaningful revenue
  if (selfAssessment === 'driver_strategic' && arrValue >= 2000000 &&
      ['comp_notable_50m', 'comp_major_100m'].includes(marketContext)) {
    return 'strategic';
  }

  // Strategic Path 2: Bootstrapped category-creator with exceptional metrics
  // (Profitable, high-growth, high-margin, no investor pressure = maximum leverage)
  if (isBootstrapped && hasStrongEBITDA && isExceptionalGrowth && hasHighMargins && arrValue >= 10000000) {
    return 'strategic';
  }

  // Strategic Path 3: Strong growth since last raise + good current metrics + reasonable valuation
  // (You've grown into/beyond your valuation = leverage)
  if (hasGrownSinceRaise && isHighGrowth && hasHighMargins && arrValue >= 10000000 &&
      arrValue >= lastValuation * 0.3) { // ARR at least 30% of last valuation suggests reasonable multiple
    return 'strategic';
  }

  // Strategic Path 4: Deep buyer relationship + good metrics can unlock strategic premium
  if (hasDeepBuyerRelationship && arrValue >= 5000000 && isHighGrowth) {
    return 'strategic';
  }

  // Strategic Path 5: Deep tech with proprietary technology in hot market
  // Deep tech companies often have massive capital requirements before revenue
  // but can command strategic premiums for their technology/IP
  if (isDeepTech && (selfAssessment === 'driver_ip' || selfAssessment === 'driver_strategic') &&
      ['comp_notable_50m', 'comp_major_100m'].includes(marketContext)) {
    return 'strategic';
  }

  // Strategic Path 6: Deep tech with deep buyer relationship (even pre-revenue)
  if (isDeepTech && hasDeepBuyerRelationship) {
    return 'strategic';
  }

  // Asset Sale Override: Raised significant capital but flat/declining growth
  // When you've raised $5M+ but aren't growing, acquihire math doesn't work for investors
  if (isFlat && capitalRaised >= 5000000 && arrValue < 10000000) {
    return 'asset_sale';
  }

  // Asset Sale Override 2: Declined significantly since last raise at high valuation
  if (hasDeclinedSinceRaise && lastValuation >= 30000000 && arrValue < lastValuation * 0.2) {
    return 'asset_sale';
  }

  // PE/Revenue Multiple: $10M+ ARR or $2M+ EBITDA with growth
  if ((arrValue >= 10000000 || hasEBITDA) && !isFlat) {
    return 'revenue_multiple';
  }

  // Acquihire: Team is the value + limited revenue + NOT heavily funded + founders willing to stay
  // Only qualifies if the company hasn't raised too much (acquihire math needs to work)
  if ((selfAssessment === 'driver_team' || selfAssessment === 'driver_unsure') &&
      arrValue < 5000000 && capitalRaised < 5000000 && founderWillStay) {
    return 'acquihire';
  }

  // If team-focused but founders won't stay, it's an asset sale
  if (selfAssessment === 'driver_team' && founderWontStay) {
    return 'asset_sale';
  }

  // If IP-focused with limited revenue, asset sale (unless deep tech which was handled above)
  if (selfAssessment === 'driver_ip' && arrValue < 5000000 && !isDeepTech) {
    return 'asset_sale';
  }

  // If declining/flat growth, asset sale (regardless of margins)
  if (isFlat) {
    return 'asset_sale';
  }

  // Default based on revenue level
  if (arrValue >= 5000000) {
    return 'revenue_multiple';
  }

  return 'asset_sale';
}

function calculateValuationRange(answers, type) {
  const arr = getArrValue(answers.arr);
  const keyPeople = getKeyPeopleCount(answers.key_talent);
  const growthMult = getGrowthMultiplier(answers.growth);
  const marginMult = getMarginMultiplier(answers.gross_margin);
  const lastValuation = getLastValuation(answers.last_valuation);
  const isDeepTech = answers.business_type === 'deep_tech';
  const isPreRevenue = answers.arr === 'pre_revenue';
  const isRecentRaise = ['fundraise_under_12m', 'fundraise_12_24m'].includes(answers.last_fundraise);
  const isStaleRaise = ['fundraise_24_36m', 'fundraise_over_36m'].includes(answers.last_fundraise);

  let low, high;

  switch(type) {
    case 'acquihire':
      // $1-3M per key person
      low = keyPeople * 1000000;
      high = keyPeople * 3000000;
      break;

    case 'asset_sale':
      // 0.5-1.5x ARR or $500K-$5M floor
      low = Math.max(500000, arr * 0.5);
      high = Math.max(5000000, arr * 1.5);
      break;

    case 'revenue_multiple':
      // 2-5x ARR adjusted for growth and margin
      const baseMultiple = 2 + (growthMult * 1.5) + (marginMult * 0.5);
      low = arr * baseMultiple * 0.8;
      high = arr * baseMultiple * 1.2;
      break;

    case 'strategic':
      // Deep tech with low/no revenue: base on last round valuation or team value
      if (isDeepTech && isPreRevenue) {
        if (lastValuation > 0 && isRecentRaise) {
          // Recent round: valuation close to last financing
          low = lastValuation * 0.8;
          high = null; // Could exceed last round with right buyer dynamics
        } else if (lastValuation > 0 && isStaleRaise) {
          // Stale round (2+ years): significant discount
          low = lastValuation * 0.4;
          high = lastValuation * 0.7;
        } else {
          // Bootstrapped deep tech or no valuation data - base on team + IP value
          low = keyPeople * 2000000;
          high = null;
        }
      } else {
        // Standard strategic: 5x+ ARR, no upper cap
        low = arr * 5;
        high = null; // No upper cap for strategic
      }
      break;
  }

  return { low, high };
}

function formatCurrency(value) {
  if (value >= 1000000000) {
    return '$' + (value / 1000000000).toFixed(1) + 'B';
  } else if (value >= 1000000) {
    return '$' + (value / 1000000).toFixed(1) + 'M';
  } else if (value >= 1000) {
    return '$' + (value / 1000).toFixed(0) + 'K';
  }
  return '$' + value.toFixed(0);
}

function generateWarnings(answers, type, valuationRange) {
  const warnings = [];
  const capitalRaised = getCapitalRaised(answers.capital_raised);
  const lastValuation = getLastValuation(answers.last_valuation);
  // For strategic (no upper cap), use low as baseline; otherwise use midpoint
  const estimatedValue = valuationRange.high ? (valuationRange.low + valuationRange.high) / 2 : valuationRange.low;
  const isBootstrapped = answers.capital_raised === 'bootstrapped';

  // Underwater Exit: If total raised > estimated valuation
  if (capitalRaised > estimatedValue) {
    warnings.push({
      type: 'critical',
      text: 'Your liquidation preferences may exceed your likely exit value. Common shareholders (including founders with common stock) may receive little to nothing. Consider this carefully before proceeding.'
    });
  }

  // Valuation vs Raised Mismatch (less than 1x)
  if (estimatedValue < capitalRaised && estimatedValue >= capitalRaised * 0.5) {
    warnings.push({
      type: 'warning',
      text: "Your likely exit value is below what you've raised. This will require difficult conversations with investors about write-downs and may limit your deal options."
    });
  }

  // Down round warning: Last valuation significantly higher than estimated exit
  if (!isBootstrapped && lastValuation > 0 && estimatedValue < lastValuation * 0.7) {
    warnings.push({
      type: 'warning',
      text: `Your last round valuation was significantly higher than realistic exit values. This "down round" dynamic will require difficult conversations with your board and may complicate deal negotiations.`
    });
  }

  // Recent raise at high valuation warning
  if (answers.last_fundraise === 'fundraise_under_12m' && lastValuation >= 50000000) {
    warnings.push({
      type: 'info',
      text: 'You raised recently at a high valuation. Buyers will question why you\'re selling so soon. Have a clear narrative that doesn\'t signal desperation.'
    });
  }

  // Performance decline since raise
  if (['perf_declined_significantly', 'perf_declined_somewhat'].includes(answers.performance_since_raise)) {
    warnings.push({
      type: 'warning',
      text: 'Your business has declined since your last raise. Buyers will scrutinize what changed and whether the decline is reversible. Be prepared with honest answers.'
    });
  }

  // Customer Concentration Risk
  if (answers.customer_concentration === 'conc_top_50') {
    warnings.push({
      type: 'warning',
      text: 'High customer concentration is a major red flag for buyers. Consider diversifying before engaging in M&A—or expect a significant discount.'
    });
  }

  // PE Threshold Miss
  if (answers.arr === 'arr_5m_10m' && ['burn_high', 'burn_low'].includes(answers.ebitda)) {
    warnings.push({
      type: 'info',
      text: 'PE buyers typically require $2M+ EBITDA with predictable margins. Focus on reaching profitability before engaging financial buyers.'
    });
  }

  // Acquihire market reality
  if (type === 'acquihire') {
    warnings.push({
      type: 'info',
      text: 'Since 2023, acquihires for “solid but generic” engineering or product teams have gotten much harder. AI has increased productivity per engineer, shrinking demand for headcount and pushing deals toward longer processes and lower prices. Unless the team includes standout AI research talent, this is a difficult path in the current market.'
    });
  }

  // Earnout warning for PE/revenue-multiple deals
  if (type === 'revenue_multiple') {
    warnings.push({
      type: 'info',
      text: 'PE and financial buyers typically structure deals with earnouts tied to future performance. Expect 20-50% of the deal value to be contingent on hitting post-acquisition targets.'
    });
  }

  // Distressed asset sale with significant capital raised
  if (type === 'asset_sale' && capitalRaised >= 5000000) {
    warnings.push({
      type: 'warning',
      text: 'With significant capital raised and limited growth, this will likely be a difficult exit. Investor returns may be minimal, and the deal structure will favor asset buyers who can cherry-pick what they want.'
    });
  }

  // Complex liquidation preferences
  if (['liq_2x_plus', 'liq_complex'].includes(answers.liq_pref)) {
    warnings.push({
      type: 'warning',
      text: 'Complex or stacked liquidation preferences make deals harder to close. Buyers may require a cap table cleanup before proceeding.'
    });
  }

  return warnings;
}

function generateKeyFactors(answers, type) {
  const factors = [];
  const arr = getArrValue(answers.arr);
  const keyPeople = getKeyPeopleCount(answers.key_talent);
  const capitalRaised = getCapitalRaised(answers.capital_raised);
  const lastValuation = getLastValuation(answers.last_valuation);
  const isBootstrapped = answers.capital_raised === 'bootstrapped';

  switch(type) {
    case 'acquihire':
      factors.push({ text: `${Math.round(keyPeople)} key technical people valued at $1-3M each`, sentiment: 'positive' });
      if (arr < 1000000) {
        factors.push({ text: 'Limited revenue supports talent-focused valuation', sentiment: 'neutral' });
      }
      factors.push({ text: 'Deal structure will be 70-90% retention bonuses', sentiment: 'neutral' });
      if (['commit_excited', 'commit_willing'].includes(answers.founder_commitment)) {
        factors.push({ text: 'Team willingness to stay is essential for acquihire success', sentiment: 'positive' });
      }
      break;

    case 'asset_sale':
      if (['declining', 'flat'].includes(answers.growth)) {
        factors.push({ text: 'Flat or declining growth limits buyer interest', sentiment: 'negative' });
      }
      if (capitalRaised >= 5000000) {
        factors.push({ text: `${formatCurrency(capitalRaised)} raised creates investor expectations that may not be met`, sentiment: 'negative' });
      }
      if (['perf_declined_significantly', 'perf_declined_somewhat'].includes(answers.performance_since_raise)) {
        factors.push({ text: 'Decline since last raise weakens negotiating position', sentiment: 'negative' });
      }
      if (answers.value_driver === 'driver_ip') {
        factors.push({ text: 'IP/technology may have value separate from the business', sentiment: 'positive' });
      }
      if (answers.value_driver === 'driver_team') {
        factors.push({ text: 'Team retention packages may supplement asset value', sentiment: 'neutral' });
      }
      factors.push({ text: 'Buyers will cherry-pick valuable assets', sentiment: 'neutral' });
      break;

    case 'revenue_multiple':
      factors.push({ text: `${formatCurrency(arr)} ARR provides PE buyer foundation`, sentiment: 'positive' });
      if (['strong', 'hypergrowth', 'exceptional'].includes(answers.growth)) {
        factors.push({ text: 'Strong growth rate increases multiple', sentiment: 'positive' });
      }
      if (['margin_60_75', 'margin_above_75'].includes(answers.gross_margin)) {
        factors.push({ text: 'SaaS-level margins are attractive to buyers', sentiment: 'positive' });
      }
      if (['ebitda_500k_2m', 'ebitda_2m_5m', 'ebitda_over_5m'].includes(answers.ebitda)) {
        factors.push({ text: 'Positive EBITDA qualifies for PE consideration', sentiment: 'positive' });
      }
      if (isBootstrapped) {
        factors.push({ text: 'No investor pressure gives you negotiating leverage', sentiment: 'positive' });
      }
      if (['perf_grew_significantly', 'perf_doubled_plus'].includes(answers.performance_since_raise)) {
        factors.push({ text: 'Strong growth since last raise demonstrates momentum', sentiment: 'positive' });
      }
      if (lastValuation > 0 && arr >= lastValuation * 0.25) {
        factors.push({ text: 'Current metrics support previous valuation', sentiment: 'positive' });
      }
      break;

    case 'strategic':
      if (isBootstrapped && ['ebitda_2m_5m', 'ebitda_over_5m'].includes(answers.ebitda)) {
        factors.push({ text: 'Profitable and bootstrapped = maximum leverage', sentiment: 'positive' });
      }
      factors.push({ text: 'Strategic narrative can drive premium valuation', sentiment: 'positive' });
      if (['comp_notable_50m', 'comp_major_100m'].includes(answers.comparables)) {
        factors.push({ text: 'Strong comparable exits support higher multiples', sentiment: 'positive' });
      }
      if (['hypergrowth', 'exceptional'].includes(answers.growth)) {
        factors.push({ text: 'Exceptional growth makes you a category-defining acquisition', sentiment: 'positive' });
      }
      if (['perf_grew_significantly', 'perf_doubled_plus'].includes(answers.performance_since_raise)) {
        factors.push({ text: 'You\'ve grown into/beyond your last valuation', sentiment: 'positive' });
      }
      if (answers.buyer_relationships === 'rel_deep_partnership') {
        factors.push({ text: 'Deep partnership gives you inside track with potential buyer', sentiment: 'positive' });
      }
      if (answers.business_type === 'deep_tech') {
        factors.push({ text: 'Deep tech companies can command premiums for proprietary technology', sentiment: 'positive' });
      }
      factors.push({ text: 'Valuation depends on competitive buyer dynamics', sentiment: 'neutral' });
      factors.push({ text: 'Deal structure varies—strategic buyers often pay more upfront', sentiment: 'neutral' });
      break;
  }

  // Add concentration factor if relevant
  if (answers.customer_concentration === 'conc_highly_diversified') {
    factors.push({ text: 'Diversified customer base reduces deal risk', sentiment: 'positive' });
  }

  // Add stale fundraise factor
  if (answers.last_fundraise === 'fundraise_over_36m') {
    factors.push({ text: 'Last raise was 3+ years ago—valuation expectations may be adjustable', sentiment: 'neutral' });
  }

  // Add buyer relationship factors
  if (answers.buyer_relationships === 'rel_deep_partnership') {
    factors.push({ text: 'Deep buyer relationship increases strategic premium likelihood', sentiment: 'positive' });
  } else if (answers.buyer_relationships === 'rel_customer_vendor') {
    factors.push({ text: 'Existing business relationship provides warm intro path', sentiment: 'positive' });
  } else if (answers.buyer_relationships === 'rel_none') {
    factors.push({ text: 'No existing buyer relationships—will need to build from scratch', sentiment: 'negative' });
  }

  // Add founder commitment factors
  if (answers.founder_commitment === 'commit_excited') {
    factors.push({ text: 'Team excited to stay increases deal attractiveness', sentiment: 'positive' });
  } else if (answers.founder_commitment === 'commit_no') {
    if (type === 'acquihire') {
      factors.push({ text: 'Clean exit preference limits acquihire options', sentiment: 'negative' });
    } else {
      factors.push({ text: 'Clean exit preference may reduce retention-heavy deal structures', sentiment: 'neutral' });
    }
  }

  // Add deep tech factors
  if (answers.business_type === 'deep_tech') {
    if (type === 'strategic') {
      factors.push({ text: 'Deep tech with defensible IP can command strategic premiums', sentiment: 'positive' });
    }
    if (arr < 2000000) {
      factors.push({ text: 'Pre-revenue deep tech valued on technology milestones, not ARR', sentiment: 'neutral' });
    }
    // Round timing factors for deep tech
    if (answers.arr === 'pre_revenue') {
      if (['fundraise_24_36m', 'fundraise_over_36m'].includes(answers.last_fundraise)) {
        factors.push({ text: 'Round is 2+ years old—expect significant discount to last valuation', sentiment: 'negative' });
      } else if (['fundraise_under_12m', 'fundraise_12_24m'].includes(answers.last_fundraise)) {
        factors.push({ text: 'Recent round supports valuation close to last financing', sentiment: 'positive' });
      } else if (answers.capital_raised === 'bootstrapped') {
        factors.push({ text: 'Bootstrapped deep tech valued on team and IP, not prior round', sentiment: 'neutral' });
      }
    }
  }

  return factors;
}

function showValuationResults() {
  document.getElementById('valuation-question-section').classList.add('hidden');
  document.getElementById('valuation-results-section').classList.remove('hidden');

  // Make sure valuation range and factors are visible (may be hidden from early exit)
  document.getElementById('valuation-range-box').style.display = 'block';
  document.getElementById('valuation-factors').style.display = 'block';

  const type = calculateValuationType(valuationAnswers);
  const outcome = valuationOutcomes[type];
  const valuationRange = calculateValuationRange(valuationAnswers, type);
  const warnings = generateWarnings(valuationAnswers, type, valuationRange);
  const factors = generateKeyFactors(valuationAnswers, type);

  // Display warnings
  const warningsContainer = document.getElementById('valuation-warnings');
  warningsContainer.innerHTML = '';
  warnings.forEach(warning => {
    const div = document.createElement('div');
    div.className = 'q-warning';
    div.innerHTML = warning.text;
    warningsContainer.appendChild(div);
  });

  // Display title and description
  document.getElementById('valuation-result-title').textContent = outcome.title;
  document.getElementById('valuation-result-description').innerHTML = outcome.description;

  // Display valuation range
  const rangeValue = document.getElementById('valuation-range-value');
  const rangeNote = document.getElementById('valuation-range-note');

  if (type === 'strategic') {
    const arr = getArrValue(valuationAnswers.arr);
    const isDeepTech = valuationAnswers.business_type === 'deep_tech';
    const isPreRevenue = valuationAnswers.arr === 'pre_revenue';
    const isBootstrapped = valuationAnswers.capital_raised === 'bootstrapped';
    const lastVal = getLastValuation(valuationAnswers.last_valuation);

    if (valuationRange.high === null) {
      // No upper cap for strategic deals
      if (isDeepTech && isPreRevenue) {
        rangeValue.textContent = `${formatCurrency(valuationRange.low)}+`;
        if (isBootstrapped || lastVal === 0) {
          rangeNote.textContent = 'Based on team and IP value. Strategic premiums possible with right buyer dynamics.';
        } else {
          rangeNote.textContent = 'Based on last round valuation. Strategic premiums possible with right buyer dynamics.';
        }
      } else {
        const lowMult = (valuationRange.low / arr).toFixed(0);
        rangeValue.textContent = `${formatCurrency(valuationRange.low)}+`;
        rangeNote.textContent = `${lowMult}x+ ARR. Strategic premiums are narrative-driven with no ceiling.`;
      }
    } else {
      // Deep tech with stale round - has upper cap
      rangeValue.textContent = `${formatCurrency(valuationRange.low)} - ${formatCurrency(valuationRange.high)}`;
      rangeNote.textContent = 'Stale round (2+ years) typically means significant discount to last valuation.';
    }
  } else {
    rangeValue.textContent = `${formatCurrency(valuationRange.low)} - ${formatCurrency(valuationRange.high)}`;

    if (type === 'acquihire') {
      rangeNote.textContent = 'Based on key personnel count. 70-90% will be retention.';
    } else if (type === 'asset_sale') {
      rangeNote.textContent = 'Asset sales vary widely based on specific buyer needs.';
    } else if (type === 'revenue_multiple') {
      const arr = getArrValue(valuationAnswers.arr);
      const lowMult = (valuationRange.low / arr).toFixed(1);
      const highMult = (valuationRange.high / arr).toFixed(1);
      rangeNote.textContent = `${lowMult}x - ${highMult}x ARR based on growth and margins.`;
    }
  }

  // Display key factors
  const factorsList = document.getElementById('valuation-factors-list');
  factorsList.innerHTML = '';
  factors.forEach(factor => {
    const div = document.createElement('div');
    div.className = 'valuation-factor-item valuation-factor-' + factor.sentiment;
    div.textContent = factor.text;
    factorsList.appendChild(div);
  });

  // Display chapters
  const chaptersList = document.getElementById('valuation-chapters-list');
  chaptersList.innerHTML = '';
  outcome.chapters.forEach(ch => {
    const div = document.createElement('div');
    div.className = 'q-chapter-item';
    div.innerHTML = `<a href="ma-book/chapter-${ch.num}.html" class="q-chapter-link"><span class="q-chapter-num">Ch. ${ch.num}</span> ${ch.title}</a>`;
    chaptersList.appendChild(div);
  });
}

function restartValuationAssessment() {
  valuationAnswers = {};
  valuationCurrentQuestion = 0;
  valuationQuestionHistory = [];
  document.getElementById('valuation-results-section').classList.add('hidden');
  document.getElementById('valuation-question-section').classList.add('hidden');
  document.getElementById('valuation-tool-content').classList.add('hidden');
  document.getElementById('valuation-start-btn').classList.remove('hidden');
  // Reset visibility of optional sections
  document.getElementById('valuation-range-box').style.display = 'block';
  document.getElementById('valuation-factors').style.display = 'block';
}

// ==========================================
// VET YOUR INBOUND ASSESSMENT
// ==========================================

const inboundQuestions = [
  {
    id: 'source',
    text: 'Who reached out to you?',
    hint: 'The seniority and role of the person reaching out is one of the strongest signals of real intent.',
    answers: [
      { value: 'ceo_founder', label: 'CEO or Founder' },
      { value: 'c_level', label: 'C-level executive (CTO, CFO, COO, etc.)' },
      { value: 'vp_gm', label: 'VP or GM of a business unit' },
      { value: 'corp_dev', label: 'Corp Dev or M&A team member' },
      { value: 'pm_em', label: 'Product Manager, Engineering Manager, or similar' },
      { value: 'pe_analyst', label: 'PE/VC analyst or associate' },
      { value: 'banker', label: 'Investment banker representing another company' },
      { value: 'unknown', label: 'Unknown or can\'t determine' }
    ]
  },
  {
    id: 'channel',
    text: 'How did they reach you?',
    answers: [
      { value: 'board_intro', label: 'Warm intro from your board member or investor' },
      { value: 'mutual_intro', label: 'Warm intro from a mutual contact' },
      { value: 'existing_relationship', label: 'Direct outreach—we have an existing relationship' },
      { value: 'cold_outreach', label: 'Cold email or LinkedIn message' },
      { value: 'conference', label: 'Met at a conference or event' },
      { value: 'through_banker', label: 'Through a banker or advisor' }
    ]
  },
  {
    id: 'company_type',
    text: 'What type of company is reaching out?',
    answers: [
      { value: 'big_tech', label: 'Big tech (Google, Apple, Microsoft, Meta, Amazon, etc.)' },
      { value: 'large_public', label: 'Large public company (not big tech)' },
      { value: 'growth_startup', label: 'Well-funded growth-stage startup' },
      { value: 'pe_firm', label: 'Private equity firm' },
      { value: 'strategic_midsize', label: 'Strategic corporate (mid-size, private)' },
      { value: 'small_unknown', label: 'Smaller company or unknown' }
    ]
  },
  {
    id: 'stated_intent',
    text: 'What did they say they want?',
    answers: [
      { value: 'explicit_acquisition', label: 'Explicitly mentioned acquisition interest' },
      { value: 'exploratory', label: '"Exploratory conversation" or "getting to know you"' },
      { value: 'partnership', label: 'Partnership or collaboration discussion' },
      { value: 'investment', label: 'Investment discussion' },
      { value: 'vague', label: 'Vague or unclear intent' }
    ]
  },
  {
    id: 'specificity',
    text: 'How specific was their interest?',
    hint: 'Specificity signals real homework has been done—generic praise often means mass outreach.',
    answers: [
      { value: 'very_specific', label: 'Mentioned specific product, technology, or team they\'re interested in' },
      { value: 'referenced_news', label: 'Referenced recent news, announcement, or something specific about us' },
      { value: 'generic_praise', label: 'Generic "love what you\'re doing" or "impressed by your work"' },
      { value: 'template', label: 'Clearly a template or form letter' }
    ]
  },
  {
    id: 'focus_area',
    text: 'What are they asking about?',
    hint: 'What they focus on reveals what they actually want to acquire.',
    answers: [
      { value: 'team', label: 'Our team—org structure, key people, who would come over' },
      { value: 'technology', label: 'Our technology or IP specifically' },
      { value: 'business', label: 'Our revenue, customers, and business metrics' },
      { value: 'strategic_fit', label: 'Strategic fit and how we\'d integrate with their roadmap' },
      { value: 'general', label: 'General "tell me about your company"' }
    ]
  },
  {
    id: 'acq_history',
    text: 'Do they have acquisition history?',
    answers: [
      { value: 'serial', label: 'Yes—serial acquirer (10+ acquisitions in recent years)' },
      { value: 'occasional', label: 'Yes—occasional acquirer (a few acquisitions)' },
      { value: 'acquihire_known', label: 'They\'re known for acquihires specifically' },
      { value: 'first_time', label: 'First-time acquirer or unknown history' },
      { value: 'not_sure', label: 'Not sure—haven\'t researched yet' }
    ]
  },
  {
    id: 'existing_relationship',
    text: 'Do you have an existing business relationship with them?',
    answers: [
      { value: 'customer_partner', label: 'Yes—they\'re a customer, partner, or vendor' },
      { value: 'licensing', label: 'Yes—we have a licensing or integration deal' },
      { value: 'talked_before', label: 'We\'ve talked before but no formal relationship' },
      { value: 'no_relationship', label: 'No prior relationship' }
    ]
  }
];

const inboundOutcomes = {
  // HIGH SIGNAL outcomes
  strategic_ceo_outreach: {
    signal: 'high',
    title: 'High Signal: CEO/Founder Direct Outreach',
    description: `
      <p>When a CEO or founder reaches out directly about acquisition, <strong>this is the highest-signal inbound you can receive</strong>. They don't waste time on fishing expeditions—their time is too valuable.</p>
      <p>This doesn't mean a deal will happen, but it means there's genuine interest at the decision-making level. The person reaching out can actually make this happen.</p>
    `,
    nextSteps: [
      'Take the meeting seriously—prepare as if this is real',
      'Research their acquisition history and recent deals',
      'Understand their strategic priorities before the call',
      'Don\'t oversell—listen more than you talk',
      'Inform your board, but keep the circle small for now'
    ],
    chapters: [
      { num: 21, title: 'Engage Inbound, Lean In and Learn' },
      { num: 22, title: 'The Inside View from an Inbound Reach Out' },
      { num: 26, title: 'First Meetings Are Typically Smoke Tests' }
    ]
  },
  warm_strategic: {
    signal: 'high',
    title: 'High Signal: Warm Intro with Strategic Intent',
    description: `
      <p>A warm introduction combined with senior-level contact and specific interest is a strong signal. <strong>Someone with credibility vouched for this conversation</strong>, and the acquirer did their homework.</p>
      <p>The warm intro also means you have a backchannel—your introducer can often provide context on what's really going on inside the acquiring company.</p>
    `,
    nextSteps: [
      'Thank your introducer and ask for any context they have',
      'Research the company\'s strategic priorities and recent moves',
      'Prepare thoughtful questions about their interest',
      'Take the meeting—this is worth your time',
      'Keep your introducer updated (they have reputation at stake too)'
    ],
    chapters: [
      { num: 21, title: 'Engage Inbound, Lean In and Learn' },
      { num: 22, title: 'The Inside View from an Inbound Reach Out' },
      { num: 4, title: 'Caught Off Guard: Handling M&A Inquiries Before You\'re Ready' }
    ]
  },
  active_acquirer: {
    signal: 'high',
    title: 'High Signal: Active Acquirer with Clear Intent',
    description: `
      <p>This company has a track record of completing acquisitions and has reached out with clear intent. <strong>They know how to buy companies</strong>, which means the process is more likely to be professional and reach a conclusion.</p>
      <p>Serial acquirers also tend to move faster and have clearer internal processes. They've done this before.</p>
    `,
    nextSteps: [
      'Research their recent acquisitions—what did they pay? How did integration go?',
      'Talk to founders they\'ve acquired if possible',
      'Understand their typical deal structure and timeline',
      'Be prepared for a more structured process',
      'They\'ll likely have a playbook—learn what it is'
    ],
    chapters: [
      { num: 21, title: 'Engage Inbound, Lean In and Learn' },
      { num: 26, title: 'First Meetings Are Typically Smoke Tests' },
      { num: 30, title: 'The $$$ Expectation Alignment Conversation' }
    ]
  },
  pe_thesis_fit: {
    signal: 'high',
    title: 'High Signal: PE Firm with Thesis Fit',
    description: `
      <p>When a PE firm reaches out and their investment thesis aligns with your space, this can be serious interest. <strong>PE firms are methodical</strong>—they research sectors deeply before reaching out.</p>
      <p>However, PE interest is different from strategic interest. They're focused on financial returns, not product integration. Expect detailed financial scrutiny and a focus on EBITDA and growth predictability.</p>
    `,
    nextSteps: [
      'Understand their investment thesis and portfolio',
      'Be prepared for detailed financial questions',
      'Know your EBITDA, growth rate, and unit economics cold',
      'Understand their typical hold period and exit strategy',
      'Ask about their operating partners and value-add approach'
    ],
    chapters: [
      { num: 21, title: 'Engage Inbound, Lean In and Learn' },
      { num: 10, title: 'Valuation Fantasies and the Art of Disappointment' },
      { num: 31, title: 'Initial Due Diligence' }
    ]
  },

  // MEDIUM SIGNAL outcomes
  corp_dev_real: {
    signal: 'medium',
    title: 'Medium Signal: Corp Dev with Good Indicators',
    description: `
      <p>Corp Dev outreach can be real, but it requires more validation. <strong>Corp Dev teams are often tasked with "market mapping"</strong>—talking to many companies to understand a space, not necessarily to buy.</p>
      <p>The positive signals here (warm intro, specific interest, or existing relationship) suggest this might be more than mapping. But stay alert for signs this is just information gathering.</p>
    `,
    nextSteps: [
      'Take the meeting, but manage your time investment',
      'Ask directly: "Is there active budget and sponsorship for this?"',
      'Find out who the internal sponsor is (which executive is pushing this)',
      'Ask about their timeline and process',
      'Don\'t share sensitive information until you understand their intent'
    ],
    warnings: [
      'Corp Dev often does "market mapping" with no intent to buy'
    ],
    chapters: [
      { num: 22, title: 'The Inside View from an Inbound Reach Out' },
      { num: 21, title: 'Engage Inbound, Lean In and Learn' },
      { num: 26, title: 'First Meetings Are Typically Smoke Tests' }
    ]
  },
  acquihire_signals: {
    signal: 'medium',
    title: 'Medium Signal: Likely an Acquihire',
    description: `
      <p>The focus on your team and people—rather than your product or revenue—suggests this is likely an <strong>acquihire</strong>: they want to buy your talent, not your business.</p>
      <p>Acquihires can be good outcomes, but set expectations accordingly. The valuation will be based on headcount and retention packages, not revenue multiples. Most of the deal value will be in retention bonuses tied to key people staying.</p>
    `,
    nextSteps: [
      'Be honest with yourself about whether this is what you want',
      'Understand that 70-90% of value will be retention, not upfront',
      'Know which team members would be essential to the deal',
      'Talk to founders who\'ve done acquihires with this company',
      'Align with your team before going deep—they\'ll need to buy in'
    ],
    warnings: [
      'Acquihire valuations are based on headcount, not revenue multiples'
    ],
    chapters: [
      { num: 22, title: 'The Inside View from an Inbound Reach Out' },
      { num: 10, title: 'Valuation Fantasies and the Art of Disappointment' },
      { num: 32, title: 'Key Employee Interviews' }
    ]
  },
  partnership_probe: {
    signal: 'medium',
    title: 'Medium Signal: Partnership as M&A Cover',
    description: `
      <p>"Partnership discussions" are sometimes a cover for M&A exploration. Companies use this framing to <strong>get a meeting without triggering alarm bells</strong>—it's less threatening than saying "we might want to buy you."</p>
      <p>This could go either way. Take the meeting, but pay attention to where the conversation goes. If they keep steering toward your team, cap table, or strategic plans, M&A might be the real agenda.</p>
    `,
    nextSteps: [
      'Take the meeting with an open mind',
      'Pay attention to what questions they actually ask',
      'If M&A comes up, don\'t act surprised—lean in',
      'A real partnership could also be valuable on its own',
      'Either outcome (partnership or M&A) can be good—stay flexible'
    ],
    chapters: [
      { num: 21, title: 'Engage Inbound, Lean In and Learn' },
      { num: 5, title: 'Manufacturing an M&A Market When None is There' },
      { num: 22, title: 'The Inside View from an Inbound Reach Out' }
    ]
  },
  needs_validation: {
    signal: 'medium',
    title: 'Medium Signal: Worth a Call to Learn More',
    description: `
      <p>The signals here are mixed—not clearly a fishing expedition, but not clearly serious either. <strong>A single call can help you determine which this is.</strong></p>
      <p>Go in with specific questions designed to separate real interest from casual exploration. Don't over-invest time until you understand their intent and authority.</p>
    `,
    nextSteps: [
      'Take a 30-minute call—low cost to learn more',
      'Ask directly about budget, timeline, and internal sponsorship',
      'Find out who else is involved in the decision',
      'Gauge their knowledge of your space and company',
      'Trust your instincts after the call'
    ],
    chapters: [
      { num: 21, title: 'Engage Inbound, Lean In and Learn' },
      { num: 26, title: 'First Meetings Are Typically Smoke Tests' },
      { num: 22, title: 'The Inside View from an Inbound Reach Out' }
    ]
  },

  // LOW SIGNAL outcomes
  fishing_expedition: {
    signal: 'low',
    title: 'Low Signal: Likely a Fishing Expedition',
    description: `
      <p>Cold outreach from a junior person with generic interest is the classic <strong>fishing expedition</strong>. Corp Dev teams, PE analysts, and bankers send hundreds of these emails. Most lead nowhere.</p>
      <p>This doesn't mean you should ignore it entirely—sometimes real interest starts with a junior person doing research. But invest minimal time until you see stronger signals.</p>
    `,
    nextSteps: [
      'Reply politely but don\'t clear your calendar',
      'Ask qualifying questions before agreeing to a call',
      'Find out who the senior sponsor is',
      'Request more specifics about their interest',
      'If they can\'t answer basic questions, deprioritize'
    ],
    warnings: [
      'Most cold Corp Dev outreach is market mapping, not real interest'
    ],
    chapters: [
      { num: 22, title: 'The Inside View from an Inbound Reach Out' },
      { num: 21, title: 'Engage Inbound, Lean In and Learn' },
      { num: 29, title: 'Common Pitfalls in the Opening Game' }
    ]
  },
  banker_fishing: {
    signal: 'low',
    title: 'Low Signal: Banker Fishing for Mandates',
    description: `
      <p>Investment bankers reaching out on behalf of "unnamed clients" are often <strong>fishing for mandates</strong>, not representing real buyers. They want to sign you as a client, then go find buyers.</p>
      <p>If there's a real buyer, ask who it is. A legitimate banker with a real client will tell you (under NDA if needed). Vague "we have interested parties" language is a red flag.</p>
    `,
    nextSteps: [
      'Ask who the buyer is—a real banker will tell you',
      'Be skeptical of "unnamed strategic" or "several interested parties"',
      'Don\'t sign any engagement letters based on vague promises',
      'If they push for exclusivity without naming buyers, decline',
      'A real buyer would reach out directly or through a warm intro'
    ],
    warnings: [
      'Bankers often fish for deals to then shop around—no real buyer yet'
    ],
    chapters: [
      { num: 16, title: 'Should You Hire a Banker?' },
      { num: 22, title: 'The Inside View from an Inbound Reach Out' },
      { num: 29, title: 'Common Pitfalls in the Opening Game' }
    ]
  },
  intel_gathering: {
    signal: 'low',
    title: 'Low Signal: Possible Intelligence Gathering',
    description: `
      <p>The combination of signals here suggests this might be <strong>competitive intelligence gathering</strong> rather than real acquisition interest. Companies sometimes use "M&A exploration" as cover to learn about competitors.</p>
      <p>Be careful what you share. General information is fine, but don't reveal strategic plans, customer details, or technical secrets until you've validated the interest is real.</p>
    `,
    nextSteps: [
      'Be polite but guarded with sensitive information',
      'Don\'t share customer names, roadmaps, or technical details',
      'Ask probing questions about their actual intent',
      'If something feels off, trust your instincts',
      'Consider whether they\'re a competitor in disguise'
    ],
    warnings: [
      'Could be competitive intelligence—be careful what you share'
    ],
    chapters: [
      { num: 22, title: 'The Inside View from an Inbound Reach Out' },
      { num: 29, title: 'Common Pitfalls in the Opening Game' },
      { num: 31, title: 'Initial Due Diligence' }
    ]
  },
  too_vague: {
    signal: 'low',
    title: 'Low Signal: Too Vague to Evaluate',
    description: `
      <p>The outreach is too vague to determine real intent. <strong>Generic interest without specifics usually means this is one of many outreach emails</strong> they're sending.</p>
      <p>Don't invest significant time until they demonstrate more serious intent. A quick email asking for specifics can help you filter this.</p>
    `,
    nextSteps: [
      'Reply asking for more specifics about their interest',
      'Ask what specifically caught their attention about your company',
      'Request clarity on who is involved and what the timeline is',
      'If they can\'t provide details, deprioritize',
      'Don\'t take a meeting until they show real homework'
    ],
    chapters: [
      { num: 22, title: 'The Inside View from an Inbound Reach Out' },
      { num: 21, title: 'Engage Inbound, Lean In and Learn' },
      { num: 29, title: 'Common Pitfalls in the Opening Game' }
    ]
  },
  first_time_buyer: {
    signal: 'low',
    title: 'Low Signal: First-Time Acquirer Risk',
    description: `
      <p>Companies without acquisition experience often <strong>underestimate how hard M&A is</strong>. They may have genuine interest but lack the internal processes, budget approval, or integration capability to close a deal.</p>
      <p>Many first-time acquirers get cold feet during diligence or can't get internal approval. Proceed with caution and don't put all your eggs in this basket.</p>
    `,
    nextSteps: [
      'Ask about their internal approval process',
      'Find out who needs to sign off and whether they\'re involved',
      'Understand their timeline expectations (often unrealistic)',
      'Don\'t stop other conversations—first-time buyers often fail to close',
      'Consider whether you\'d be comfortable "teaching" them M&A'
    ],
    warnings: [
      'First-time acquirers often fail to close—don\'t rely solely on this'
    ],
    chapters: [
      { num: 22, title: 'The Inside View from an Inbound Reach Out' },
      { num: 26, title: 'First Meetings Are Typically Smoke Tests' },
      { num: 33, title: 'Surviving the Middle Game' }
    ]
  }
};

let inboundCurrentQuestion = 0;
let inboundAnswers = {};
let inboundQuestionHistory = [];

function startInboundAssessment() {
  document.getElementById('inbound-start-btn').classList.add('hidden');
  document.getElementById('inbound-tool-content').classList.remove('hidden');
  document.getElementById('inbound-question-section').classList.remove('hidden');
  inboundQuestionHistory = [];
  showInboundQuestion(0);
}

function showInboundQuestion(index) {
  inboundCurrentQuestion = index;
  const question = inboundQuestions[index];

  document.getElementById('inbound-progress-fill').style.width = ((index + 1) / inboundQuestions.length * 100) + '%';
  document.getElementById('inbound-progress-text').textContent = `Question ${index + 1} of ${inboundQuestions.length}`;
  document.getElementById('inbound-question-text').textContent = question.text;

  const hintEl = document.getElementById('inbound-question-hint');
  if (question.hint) {
    hintEl.textContent = question.hint;
    hintEl.style.display = 'block';
  } else {
    hintEl.style.display = 'none';
  }

  const container = document.getElementById('inbound-answers-container');
  container.innerHTML = '';

  question.answers.forEach(answer => {
    const btn = document.createElement('button');
    btn.className = 'q-answer-btn' + (inboundAnswers[question.id] === answer.value ? ' selected' : '');
    btn.textContent = answer.label;
    btn.onclick = function() { selectInboundAnswer(question.id, answer.value, this); };
    container.appendChild(btn);
  });

  document.getElementById('inbound-back-btn').classList.toggle('hidden', inboundQuestionHistory.length === 0);
}

function selectInboundAnswer(questionId, value, element) {
  inboundAnswers[questionId] = value;
  document.querySelectorAll('#inbound-answers-container .q-answer-btn').forEach(btn => btn.classList.remove('selected'));
  element.classList.add('selected');

  setTimeout(() => {
    if (inboundCurrentQuestion < inboundQuestions.length - 1) {
      inboundQuestionHistory.push(inboundCurrentQuestion);
      showInboundQuestion(inboundCurrentQuestion + 1);
    } else {
      showInboundResults();
    }
  }, 200);
}

function inboundGoBack() {
  if (inboundQuestionHistory.length > 0) {
    const prevIndex = inboundQuestionHistory.pop();
    showInboundQuestion(prevIndex);
  }
}

function calculateInboundOutcome() {
  const a = inboundAnswers;

  // Signal strength factors
  const isCeoFounder = a.source === 'ceo_founder';
  const isCLevel = a.source === 'c_level';
  const isVpGm = a.source === 'vp_gm';
  const isCorpDev = a.source === 'corp_dev';
  const isPmEm = a.source === 'pm_em';
  const isPeAnalyst = a.source === 'pe_analyst';
  const isBanker = a.source === 'banker';
  const isUnknownSource = a.source === 'unknown';

  const isWarmIntro = ['board_intro', 'mutual_intro'].includes(a.channel);
  const hasExistingRelationship = a.channel === 'existing_relationship' || ['customer_partner', 'licensing'].includes(a.existing_relationship);
  const isColdOutreach = a.channel === 'cold_outreach';
  const isThroughBanker = a.channel === 'through_banker';

  const isExplicitAcquisition = a.stated_intent === 'explicit_acquisition';
  const isExploratory = a.stated_intent === 'exploratory';
  const isPartnershipIntent = a.stated_intent === 'partnership';
  const isVagueIntent = a.stated_intent === 'vague';

  const isVerySpecific = a.specificity === 'very_specific';
  const isReferencedNews = a.specificity === 'referenced_news';
  const isGenericPraise = a.specificity === 'generic_praise';
  const isTemplate = a.specificity === 'template';

  const focusTeam = a.focus_area === 'team';
  const focusTechnology = a.focus_area === 'technology';
  const focusBusiness = a.focus_area === 'business';
  const focusStrategic = a.focus_area === 'strategic_fit';
  const focusGeneral = a.focus_area === 'general';

  const isSerialAcquirer = a.acq_history === 'serial';
  const isOccasionalAcquirer = a.acq_history === 'occasional';
  const isAcquihireKnown = a.acq_history === 'acquihire_known';
  const isFirstTimeAcquirer = a.acq_history === 'first_time';

  const isPeFirm = a.company_type === 'pe_firm';
  const isBigTech = a.company_type === 'big_tech';

  // HIGH SIGNAL paths

  // CEO/Founder direct outreach with any real signal
  if (isCeoFounder && (isExplicitAcquisition || isVerySpecific || hasExistingRelationship)) {
    return 'strategic_ceo_outreach';
  }

  // C-level with specific interest
  if (isCLevel && (isExplicitAcquisition || isVerySpecific) && !isColdOutreach) {
    return 'strategic_ceo_outreach';
  }

  // Warm intro + senior person + specific interest
  if (isWarmIntro && (isCeoFounder || isCLevel || isVpGm) && (isVerySpecific || isReferencedNews)) {
    return 'warm_strategic';
  }

  // Serial acquirer with clear intent
  if (isSerialAcquirer && (isExplicitAcquisition || isVerySpecific) && !isTemplate) {
    return 'active_acquirer';
  }

  // PE firm with specific interest
  if (isPeFirm && (isVerySpecific || isReferencedNews) && (focusBusiness || focusStrategic)) {
    return 'pe_thesis_fit';
  }

  // MEDIUM SIGNAL paths

  // Corp dev with good signals (warm intro or existing relationship)
  if (isCorpDev && (isWarmIntro || hasExistingRelationship) && !isTemplate) {
    return 'corp_dev_real';
  }

  // Focus on team = likely acquihire
  if (focusTeam && (isBigTech || isAcquihireKnown)) {
    return 'acquihire_signals';
  }

  // Acquihire-known company reaching out
  if (isAcquihireKnown && !focusStrategic && !focusBusiness) {
    return 'acquihire_signals';
  }

  // Partnership discussion with some positive signals
  if (isPartnershipIntent && (isWarmIntro || hasExistingRelationship || isCLevel || isVpGm)) {
    return 'partnership_probe';
  }

  // Mixed signals worth validating
  if ((isCorpDev || isVpGm) && (isExploratory || isPartnershipIntent) && !isTemplate && !isColdOutreach) {
    return 'needs_validation';
  }

  // Existing relationship + any outreach
  if (hasExistingRelationship && !isTemplate) {
    return 'needs_validation';
  }

  // LOW SIGNAL paths

  // Banker fishing
  if (isBanker || isThroughBanker) {
    if (isColdOutreach || isVagueIntent || isGenericPraise) {
      return 'banker_fishing';
    }
    return 'needs_validation';
  }

  // Cold + junior + generic = fishing expedition
  if (isColdOutreach && (isCorpDev || isPmEm || isPeAnalyst) && (isGenericPraise || isTemplate)) {
    return 'fishing_expedition';
  }

  // Template or very generic
  if (isTemplate || (isGenericPraise && isVagueIntent)) {
    return 'too_vague';
  }

  // First-time acquirer risk
  if (isFirstTimeAcquirer && !isCeoFounder && !isWarmIntro) {
    return 'first_time_buyer';
  }

  // Unknown source + cold + vague = possible intel gathering
  if ((isUnknownSource || isPmEm) && isColdOutreach && focusGeneral) {
    return 'intel_gathering';
  }

  // Cold outreach with generic interest
  if (isColdOutreach && (isGenericPraise || isVagueIntent || focusGeneral)) {
    return 'fishing_expedition';
  }

  // Default: needs more information
  return 'needs_validation';
}

function showInboundResults() {
  document.getElementById('inbound-question-section').classList.add('hidden');
  document.getElementById('inbound-results-section').classList.remove('hidden');

  const outcomeKey = calculateInboundOutcome();
  const outcome = inboundOutcomes[outcomeKey];

  // Display signal badge
  const badge = document.getElementById('inbound-signal-badge');
  badge.textContent = outcome.signal === 'high' ? 'High Signal' : outcome.signal === 'medium' ? 'Medium Signal' : 'Low Signal';
  badge.className = 'inbound-signal-badge signal-' + outcome.signal;

  // Display warnings if any
  const warningsContainer = document.getElementById('inbound-warnings');
  warningsContainer.innerHTML = '';
  if (outcome.warnings) {
    outcome.warnings.forEach(warning => {
      const div = document.createElement('div');
      div.className = 'q-warning';
      div.innerHTML = warning;
      warningsContainer.appendChild(div);
    });
  }

  // Display title and description
  document.getElementById('inbound-result-title').textContent = outcome.title;
  document.getElementById('inbound-result-description').innerHTML = outcome.description;

  // Display next steps
  const stepsList = document.getElementById('inbound-steps-list');
  stepsList.innerHTML = '';
  outcome.nextSteps.forEach(step => {
    const div = document.createElement('div');
    div.className = 'inbound-step-item';
    div.textContent = step;
    stepsList.appendChild(div);
  });

  // Display chapters
  const chaptersList = document.getElementById('inbound-chapters-list');
  chaptersList.innerHTML = '';
  outcome.chapters.forEach(ch => {
    const div = document.createElement('div');
    div.className = 'q-chapter-item';
    div.innerHTML = `<a href="ma-book/chapter-${ch.num}.html" class="q-chapter-link"><span class="q-chapter-num">Ch. ${ch.num}</span> ${ch.title}</a>`;
    chaptersList.appendChild(div);
  });
}

function restartInboundAssessment() {
  inboundAnswers = {};
  inboundCurrentQuestion = 0;
  inboundQuestionHistory = [];
  document.getElementById('inbound-results-section').classList.add('hidden');
  document.getElementById('inbound-question-section').classList.add('hidden');
  document.getElementById('inbound-tool-content').classList.add('hidden');
  document.getElementById('inbound-start-btn').classList.remove('hidden');
}

// ==========================================
// DO YOU NEED A BANKER? ASSESSMENT
// ==========================================

const bankerQuestions = [
  {
    id: 'phase',
    text: 'Where are you in your M&A journey?',
    answers: [
      { value: 'exploring', label: 'Just exploring—no conversations yet' },
      { value: 'building_relationships', label: 'Building relationships with potential acquirers' },
      { value: 'exploratory_conversations', label: 'Had exploratory conversations, nothing concrete' },
      { value: 'offer_in_hand', label: 'Have a term sheet or written offer' }
    ]
  },
  {
    id: 'inbound_quality',
    text: 'How would you describe the interest you\'ve received?',
    // Skip if exploring or have offer (offer gets its own competition question)
    condition: (answers) => !['exploring', 'offer_in_hand'].includes(answers.phase),
    answers: [
      { value: 'no_interest', label: 'No real interest yet' },
      { value: 'cold_fishing', label: 'Cold outreach from corp dev—feels like fishing' },
      { value: 'warm_single', label: 'Warm interest from one company through existing relationships' },
      { value: 'warm_multiple', label: 'Warm interest from multiple companies we have relationships with' },
      { value: 'competitive', label: 'Multiple parties actively competing—genuine bidding scenario' }
    ]
  },
  {
    id: 'offer_competition',
    text: 'Are other parties also interested in acquiring you?',
    // Only show for those with an offer in hand
    condition: (answers) => answers.phase === 'offer_in_hand',
    answers: [
      { value: 'competitive', label: 'Yes—multiple parties actively competing' },
      { value: 'potential', label: 'There\'s interest from others we could pursue' },
      { value: 'single_party', label: 'No—this is our only serious conversation' }
    ]
  },
  {
    id: 'relationships',
    text: 'Do you have existing business relationships with potential acquirers?',
    answers: [
      { value: 'multiple_deep', label: 'Yes—licensing, partnerships, or strategic investments with multiple companies' },
      { value: 'one_strong', label: 'Yes—one strong relationship (customer, partner, investor connection)' },
      { value: 'loose', label: 'Loose connections—know people but no business ties' },
      { value: 'none', label: 'No relationships with potential acquirers' }
    ]
  },
  {
    id: 'offer_acceptable',
    text: 'If you have an offer, is it acceptable?',
    // Only show if they have an offer in hand
    condition: (answers) => answers.phase === 'offer_in_hand',
    answers: [
      { value: 'very_attractive', label: 'Very attractive—exceeds expectations' },
      { value: 'reasonable', label: 'Reasonable—close to what we\'d accept' },
      { value: 'below_expectations', label: 'Below expectations—would like to test the market' },
      { value: 'not_acceptable', label: 'Not acceptable—but want to keep talking' }
    ]
  },
  {
    id: 'walkaway_power',
    text: 'Could you walk away from a deal and be okay?',
    answers: [
      { value: 'yes_optional', label: 'Yes—we\'re profitable or well-funded, M&A is optional' },
      { value: 'prefer_deal', label: 'We\'d prefer a deal but can continue operating' },
      { value: 'need_outcome', label: 'We need some outcome in the next 12-18 months' },
      { value: 'urgent', label: 'We need a deal urgently—running out of runway' }
    ]
  },
  {
    id: 'banker_relationships',
    text: 'Do you have existing relationships with M&A advisors or investment bankers?',
    answers: [
      { value: 'worked_with', label: 'Yes—worked with them before or they know our space well' },
      { value: 'introductions', label: 'Been introduced to a few through board or investors' },
      { value: 'cold_approaches', label: 'Only cold approaches from bankers seeking our business' },
      { value: 'none', label: 'No banker relationships' }
    ]
  },
  {
    id: 'process_comfort',
    text: 'How comfortable are you managing the M&A process yourself?',
    answers: [
      { value: 'very_comfortable', label: 'Very comfortable—I\'ve been through M&A before' },
      { value: 'capable', label: 'Capable—I can handle it with good legal counsel' },
      { value: 'uncertain', label: 'Uncertain—this is new territory' },
      { value: 'overwhelmed', label: 'Overwhelmed—already struggling to keep the business running' }
    ]
  },
  {
    id: 'deal_complexity',
    text: 'How complex is the deal likely to be?',
    hint: 'Bankers add the most value when complexity—not just price—is high.',
    // Skip if exploring or just building relationships
    condition: (answers) => ['exploratory_conversations', 'offer_in_hand'].includes(answers.phase),
    answers: [
      { value: 'simple_cash', label: 'Mostly cash, clean acquisition' },
      { value: 'mixed_structure', label: 'Mix of cash, equity, earnout, or retention packages' },
      { value: 'carveout', label: 'Asset carve-out, IP licensing, or partial sale' },
      { value: 'cross_border', label: 'Cross-border, regulated, or multi-entity structure' }
    ]
  },
  {
    id: 'buyer_experience',
    text: 'How experienced are the interested buyers at doing acquisitions?',
    hint: 'Inexperienced buyers create process risk.',
    // Skip if exploring or just building relationships
    condition: (answers) => ['exploratory_conversations', 'offer_in_hand'].includes(answers.phase),
    answers: [
      { value: 'serial_acquirers', label: 'Serial acquirers with clear playbooks' },
      { value: 'occasional', label: 'Strategic buyers who do M&A occasionally' },
      { value: 'first_time', label: 'First-time acquirers or unclear on process' },
      { value: 'unclear_approval', label: 'Buyer unclear on internal approval process' }
    ]
  },
  {
    id: 'stakeholder_alignment',
    text: 'How aligned are founders, board, and major shareholders on selling?',
    hint: 'Bankers work for the board, not founders—they can help build consensus and fairly represent company interests.',
    answers: [
      { value: 'fully_aligned', label: 'Fully aligned on price, timing, and outcome' },
      { value: 'minor_differences', label: 'Minor differences, but resolvable' },
      { value: 'significant_disagreement', label: 'Significant disagreement on timing or valuation' },
      { value: 'misaligned_incentives', label: 'Misaligned incentives (liquidation prefs, rollover, control)' }
    ]
  }
];

const bankerOutcomes = {
  // HIRE BANKER outcomes
  hire_banker_competitive: {
    title: 'Yes—You Have Competitive Dynamics to Leverage',
    description: `
      <p>With multiple parties actively competing and the leverage to walk away, you're in the ideal position to hire a banker. <strong>This is exactly when bankers create value</strong>—they can amplify existing interest, run a formal process, and maximize competitive tension.</p>
      <p>A good banker will help you:</p>
      <ul>
        <li>Run a structured process that creates urgency</li>
        <li>Manage communications with multiple parties simultaneously</li>
        <li>Negotiate from a position of strength</li>
        <li>Keep your focus on running the business during the process</li>
      </ul>
      <p>Be selective about which banker you choose—look for someone who knows your space and has relevant deal experience.</p>
    `,
    chapters: [
      { num: 16, title: 'Should You Hire a Banker?' },
      { num: 28, title: 'Should You Run an Official Process?' },
      { num: 21, title: 'Engage Inbound, Lean In and Learn' }
    ]
  },
  hire_banker_price_discovery: {
    title: 'Yes—A Banker Can Help You Test the Market',
    description: `
      <p>You have an offer, but it's below expectations. A banker can help you run a targeted process to discover whether better terms are available—without risking your current deal entirely.</p>
      <p><strong>Key consideration:</strong> The existing offer gives you leverage. A good banker will use it as a floor while exploring whether other parties will compete. However, be careful about timing—if your current buyer learns you're shopping the deal, they may walk or lower their offer.</p>
      <p>Make sure you're prepared for the possibility that the market confirms your current offer is actually reasonable.</p>
    `,
    chapters: [
      { num: 16, title: 'Should You Hire a Banker?' },
      { num: 42, title: 'Term Sheet Received - Where to Go from Here' },
      { num: 30, title: 'The $$$ Expectation Alignment Conversation' }
    ]
  },
  hire_banker_complexity: {
    title: 'Yes—The Deal Complexity Warrants a Banker',
    description: `
      <p>Complex deal structures require expertise you likely don't have. Bankers have seen these structures before—asset carve-outs, IP licensing arrangements, cross-border regulatory issues, multi-entity structures.</p>
      <p>Even without competitive dynamics, <strong>the cost of getting it wrong far exceeds banker fees</strong>. They'll also help ensure your lawyers focus on the right issues.</p>
      <p>Look for a banker with specific experience in your deal type. General M&A experience isn't enough for complex structures—you need someone who has closed similar deals.</p>
    `,
    chapters: [
      { num: 16, title: 'Should You Hire a Banker?' },
      { num: 17, title: 'Find a Law Firm Who Knows M&A' },
      { num: 43, title: 'Term Sheet Signed, Start of a Thousand Paper Cuts' }
    ]
  },
  hire_banker_alignment: {
    title: 'Yes—A Banker Can Help Navigate Stakeholder Dynamics',
    description: `
      <p>When stakeholders aren't aligned, having founders negotiate directly creates conflict of interest concerns. <strong>Bankers work for the board and represent the company's interests</strong>—they can build consensus, present options fairly, and ensure no single party dominates the process.</p>
      <p>This is especially valuable when:</p>
      <ul>
        <li>Liquidation preferences complicate who gets what</li>
        <li>Founders and investors have different exit timelines</li>
        <li>Board members have conflicting views on valuation</li>
        <li>Control issues need neutral arbitration</li>
      </ul>
      <p>The banker becomes a neutral party who can advocate for the deal that's best for the company as a whole.</p>
    `,
    chapters: [
      { num: 16, title: 'Should You Hire a Banker?' },
      { num: 12, title: 'Herding Cats: Aligning Spouses, Cofounders, Investors, and Employees' },
      { num: 30, title: 'The $$$ Expectation Alignment Conversation' }
    ]
  },
  early_hire_banker: {
    title: 'Yes—Ideal Conditions for a Banker',
    description: `
      <p>You have the combination that makes bankers most effective: <strong>competitive interest plus the leverage to walk away</strong>. This is exactly when bankers amplify value rather than just taking a fee.</p>
      <p>A banker can run a formal process, create urgency among competing parties, and let you focus on running the business. Don't negotiate directly when you have this much leverage—use a professional.</p>
    `,
    chapters: [
      { num: 16, title: 'Should You Hire a Banker?' },
      { num: 28, title: 'Should You Run an Official Process?' },
      { num: 21, title: 'Engage Inbound, Lean In and Learn' }
    ]
  },

  // CONDITIONAL outcomes
  consider_banker_formalize: {
    title: 'Maybe—Consider a Banker to Formalize the Process',
    description: `
      <p>You have warm interest from multiple parties, which could develop into a competitive situation. A banker might help formalize this into a real process—but it's not essential yet.</p>
      <p><strong>Questions to consider:</strong></p>
      <ul>
        <li>Are these parties genuinely interested, or just staying informed?</li>
        <li>Do you have the bandwidth to manage multiple conversations yourself?</li>
        <li>Would introducing a banker accelerate or complicate these relationships?</li>
      </ul>
      <p>If the interest is genuine and you want to run a structured process, a banker can help. But if relationships are still early, you might do better nurturing them directly first.</p>
    `,
    chapters: [
      { num: 16, title: 'Should You Hire a Banker?' },
      { num: 5, title: 'Manufacturing an M&A Market When None is There' },
      { num: 23, title: 'Activate Outbound, Plant the Seed' }
    ]
  },
  consider_banker_buyer_inexperience: {
    title: 'Maybe—The Buyer Needs Hand-Holding',
    description: `
      <p>Inexperienced buyers create process risk—they may make promises they can't keep, miss diligence issues, or lose internal support mid-deal. A banker can educate them on typical M&A process, pace the deal appropriately, and identify red flags early.</p>
      <p><strong>However</strong>, if you have a strong relationship with this buyer, you might handle this directly with good legal counsel. The question is whether introducing a banker helps or hinders the relationship.</p>
      <p>Consider a banker if:</p>
      <ul>
        <li>The buyer seems disorganized or unclear on process</li>
        <li>You're worried about their ability to close</li>
        <li>You want someone else to manage the complexity</li>
      </ul>
    `,
    chapters: [
      { num: 16, title: 'Should You Hire a Banker?' },
      { num: 17, title: 'Find a Law Firm Who Knows M&A' },
      { num: 21, title: 'Engage Inbound, Lean In and Learn' }
    ]
  },
  selective_banker_engagement: {
    title: 'Maybe—Be Selective If You Engage a Banker',
    description: `
      <p>Your situation could benefit from a banker, but it's not essential. You have some interest and reasonable leverage—a good banker could help, but a mediocre one would just take fees.</p>
      <p><strong>If you decide to engage a banker:</strong></p>
      <ul>
        <li>Look for someone who knows your specific space</li>
        <li>Check their recent deal history—have they closed similar deals?</li>
        <li>Negotiate their fee structure carefully</li>
        <li>Make sure they'll actually work your deal, not hand it to junior staff</li>
      </ul>
      <p>The wrong banker can actually hurt your process by damaging relationships or creating unnecessary friction.</p>
    `,
    chapters: [
      { num: 16, title: 'Should You Hire a Banker?' },
      { num: 28, title: 'Should You Run an Official Process?' },
      { num: 14, title: 'Come Up with an Outreach List of Potential Acquirers' }
    ]
  },
  get_other_help_first: {
    title: 'Not a Banker—But Get Help',
    description: `
      <p>You're overwhelmed, but you don't have the competitive dynamics that make bankers valuable. <strong>Hiring a banker now won't solve your problem</strong>—bankers amplify interest that exists, they don't create it.</p>
      <p><strong>What you need instead:</strong></p>
      <ul>
        <li>Strong M&A legal counsel who can advise on process</li>
        <li>An advisor or board member with M&A experience</li>
        <li>Help running the business so you can focus on the deal</li>
      </ul>
      <p>Once you've built relationships with potential acquirers and have genuine interest, then consider whether a banker makes sense.</p>
    `,
    chapters: [
      { num: 17, title: 'Find a Law Firm Who Knows M&A' },
      { num: 5, title: 'Manufacturing an M&A Market When None is There' },
      { num: 20, title: 'Don\'t Forget You Still Have a Company to Run' }
    ]
  },
  early_consider_carefully: {
    title: 'Maybe Not—You Already Have What You Need',
    description: `
      <p>You have an attractive offer without competitive dynamics. A banker might find other interested parties, but they might also complicate a deal that's already working.</p>
      <p><strong>Key questions:</strong></p>
      <ul>
        <li>Is the current offer truly acceptable, or are you hoping for more?</li>
        <li>Would shopping the deal risk losing your current buyer?</li>
        <li>Do you have the time and energy for a longer process?</li>
      </ul>
      <p>If the offer genuinely exceeds expectations, strong legal counsel may be all you need. But if you suspect better deals exist, a banker could help you find out.</p>
    `,
    chapters: [
      { num: 42, title: 'Term Sheet Received - Where to Go from Here' },
      { num: 16, title: 'Should You Hire a Banker?' },
      { num: 17, title: 'Find a Law Firm Who Knows M&A' }
    ]
  },

  // DON'T HIRE outcomes
  build_relationships_first: {
    title: 'No—Build Relationships First',
    description: `
      <p><strong>Companies are bought, not sold.</strong> Without existing relationships with potential acquirers, a banker can't help you. They can amplify interest that exists—they can't manufacture it from nothing.</p>
      <p>Your priority right now:</p>
      <ul>
        <li>Identify companies that could benefit from acquiring you</li>
        <li>Build genuine business relationships (partnerships, customers, integrations)</li>
        <li>Stay visible in your space—speak at conferences, publish thought leadership</li>
        <li>Plant seeds that can grow into acquisition interest over time</li>
      </ul>
      <p>Once you have relationships and genuine interest, revisit whether a banker makes sense.</p>
    `,
    chapters: [
      { num: 5, title: 'Manufacturing an M&A Market When None is There' },
      { num: 14, title: 'Come Up with an Outreach List of Potential Acquirers' },
      { num: 23, title: 'Activate Outbound, Plant the Seed' }
    ]
  },
  early_build_first: {
    title: 'No—Build Relationships First',
    description: `
      <p>You're just exploring M&A with no existing acquirer relationships. <strong>This is not banker territory.</strong> A banker cannot create interest where none exists—they can only amplify existing momentum.</p>
      <p>Focus on building the relationships that will eventually make M&A possible:</p>
      <ul>
        <li>Identify strategic partners, customers, or competitors who might acquire you</li>
        <li>Build genuine business relationships over time</li>
        <li>Make sure potential acquirers know who you are before you need them</li>
      </ul>
    `,
    chapters: [
      { num: 5, title: 'Manufacturing an M&A Market When None is There' },
      { num: 14, title: 'Come Up with an Outreach List of Potential Acquirers' },
      { num: 36, title: 'There is No Shame Approaching Your Competitors' }
    ]
  },
  nurture_relationship_directly: {
    title: 'No—Nurture This Relationship Directly',
    description: `
      <p>You have warm interest from one company. Introducing a banker now could actually hurt you—it signals you're running a process when you're really just having a conversation.</p>
      <p><strong>Better approach:</strong></p>
      <ul>
        <li>Deepen the relationship directly with the interested party</li>
        <li>Understand what they're looking for and whether it's a real fit</li>
        <li>Get good legal counsel lined up for when things get serious</li>
        <li>If other parties emerge and create competition, then consider a banker</li>
      </ul>
      <p>A banker makes sense when you have multiple interested parties to manage. One warm lead is a relationship to nurture, not a process to run.</p>
    `,
    chapters: [
      { num: 21, title: 'Engage Inbound, Lean In and Learn' },
      { num: 5, title: 'Manufacturing an M&A Market When None is There' },
      { num: 16, title: 'Should You Hire a Banker?' }
    ]
  },
  banker_wont_help: {
    title: 'No—A Banker Won\'t Help Here',
    description: `
      <p><strong>Bankers can amplify interest that already exists. They cannot create it.</strong> With no real interest and urgent pressure to close a deal, you're not in a position where a banker can help.</p>
      <p>Harsh truth: paying a banker fee in this situation just burns runway you don't have. They'll run a process, but if buyers aren't interested, a process won't change that.</p>
      <p><strong>Your options:</strong></p>
      <ul>
        <li>Extend runway any way you can—cut costs, raise a bridge, generate revenue</li>
        <li>Approach potential acquirers directly and honestly about your situation</li>
        <li>Consider whether winding down gracefully is better than a desperate sale</li>
      </ul>
    `,
    chapters: [
      { num: 35, title: 'It\'s Not You, Not Your Bankers, Not Your Board, It\'s the Market' },
      { num: 40, title: 'It\'s Okay to Shut it All Down' },
      { num: 36, title: 'There is No Shame Approaching Your Competitors' }
    ]
  },
  early_not_banker_territory: {
    title: 'No—This Isn\'t Banker Territory',
    description: `
      <p>You need a deal urgently but have no real interest from buyers. <strong>A banker cannot fix this.</strong> Bankers amplify existing interest—they can't manufacture demand for a company that buyers aren't interested in.</p>
      <p>Spending money on banker fees in this situation just accelerates your runway problem. Focus instead on:</p>
      <ul>
        <li>Direct outreach to potential acquirers—be honest about your situation</li>
        <li>Extending runway any way possible</li>
        <li>Considering alternatives like winding down gracefully</li>
      </ul>
    `,
    chapters: [
      { num: 35, title: 'It\'s Not You, Not Your Bankers, Not Your Board, It\'s the Market' },
      { num: 40, title: 'It\'s Okay to Shut it All Down' },
      { num: 36, title: 'There is No Shame Approaching Your Competitors' }
    ]
  }
};

let bankerCurrentQuestion = 0;
let bankerAnswers = {};
let bankerQuestionHistory = [];

function startBankerAssessment() {
  document.getElementById('banker-start-btn').classList.add('hidden');
  document.getElementById('banker-tool-content').classList.remove('hidden');
  document.getElementById('banker-question-section').classList.remove('hidden');
  bankerQuestionHistory = [];
  showBankerQuestion(0);
}

function getNextBankerQuestion(fromIndex) {
  for (let i = fromIndex + 1; i < bankerQuestions.length; i++) {
    const question = bankerQuestions[i];
    if (!question.condition || question.condition(bankerAnswers)) {
      return i;
    }
  }
  return -1;
}

function countApplicableBankerQuestions() {
  let count = 0;
  for (let i = 0; i < bankerQuestions.length; i++) {
    const question = bankerQuestions[i];
    if (!question.condition || question.condition(bankerAnswers)) {
      count++;
    }
  }
  return count;
}

function getCurrentBankerQuestionPosition() {
  let position = 0;
  for (let i = 0; i <= bankerCurrentQuestion; i++) {
    const question = bankerQuestions[i];
    if (!question.condition || question.condition(bankerAnswers)) {
      position++;
    }
  }
  return position;
}

function showBankerQuestion(index) {
  bankerCurrentQuestion = index;
  const question = bankerQuestions[index];

  const totalQuestions = countApplicableBankerQuestions();
  const currentPosition = getCurrentBankerQuestionPosition();

  document.getElementById('banker-progress-fill').style.width = (currentPosition / totalQuestions * 100) + '%';
  document.getElementById('banker-progress-text').textContent = `Question ${currentPosition} of ${totalQuestions}`;
  document.getElementById('banker-question-text').textContent = question.text;

  const hintEl = document.getElementById('banker-question-hint');
  if (question.hint) {
    hintEl.textContent = question.hint;
    hintEl.style.display = 'block';
  } else {
    hintEl.style.display = 'none';
  }

  const container = document.getElementById('banker-answers-container');
  container.innerHTML = '';

  question.answers.forEach(answer => {
    const btn = document.createElement('button');
    btn.className = 'q-answer-btn' + (bankerAnswers[question.id] === answer.value ? ' selected' : '');
    btn.textContent = answer.label;
    btn.onclick = function() { selectBankerAnswer(question.id, answer.value, this); };
    container.appendChild(btn);
  });

  document.getElementById('banker-back-btn').classList.toggle('hidden', bankerQuestionHistory.length === 0);
}

function selectBankerAnswer(questionId, value, element) {
  bankerAnswers[questionId] = value;
  document.querySelectorAll('#banker-answers-container .q-answer-btn').forEach(btn => btn.classList.remove('selected'));
  element.classList.add('selected');

  setTimeout(() => {
    // Check for early exit conditions
    const earlyExit = checkBankerEarlyExit();
    if (earlyExit) {
      showBankerResults(earlyExit);
      return;
    }

    // Find next applicable question
    const nextIndex = getNextBankerQuestion(bankerCurrentQuestion);

    if (nextIndex !== -1) {
      bankerQuestionHistory.push(bankerCurrentQuestion);
      showBankerQuestion(nextIndex);
    } else {
      showBankerResults();
    }
  }, 200);
}

function checkBankerEarlyExit() {
  const a = bankerAnswers;

  // Normalize competition status from either question
  const isCompetitive = a.inbound_quality === 'competitive' || a.offer_competition === 'competitive';
  const hasNoRealInterest = ['no_interest', 'cold_fishing'].includes(a.inbound_quality);

  // Early exit 1: Exploring + no relationships → build relationships first
  if (a.phase === 'exploring' && a.relationships === 'none') {
    return 'early_build_first';
  }

  // Early exit 2: Desperate + no real interest → banker won't help
  if (a.walkaway_power === 'urgent' && a.inbound_quality && hasNoRealInterest) {
    return 'early_not_banker_territory';
  }

  // Early exit 3: Competitive interest + leverage → hire banker
  if (isCompetitive && ['yes_optional', 'prefer_deal'].includes(a.walkaway_power)) {
    return 'early_hire_banker';
  }

  // Early exit 4: Offer in hand + very attractive + no competition → consider carefully
  if (a.phase === 'offer_in_hand' &&
      a.offer_acceptable === 'very_attractive' &&
      !isCompetitive) {
    return 'early_consider_carefully';
  }

  return null;
}

function calculateBankerOutcome() {
  const a = bankerAnswers;

  // Primary signals - normalize from either inbound_quality or offer_competition
  const hasCompetitiveInterest = a.inbound_quality === 'competitive' || a.offer_competition === 'competitive';
  const hasWarmMultiple = a.inbound_quality === 'warm_multiple' || a.offer_competition === 'potential';
  const hasWarmSingle = a.inbound_quality === 'warm_single' || a.offer_competition === 'single_party';
  const hasNoRealInterest = ['no_interest', 'cold_fishing'].includes(a.inbound_quality);
  const hasLeverage = ['yes_optional', 'prefer_deal'].includes(a.walkaway_power);
  const isDesperate = a.walkaway_power === 'urgent';
  const hasStrongRelationships = ['multiple_deep', 'one_strong'].includes(a.relationships);
  const hasNoRelationships = a.relationships === 'none';
  const isExploring = a.phase === 'exploring';
  const isBuildingRelationships = a.phase === 'building_relationships';
  const hasOffer = a.phase === 'offer_in_hand';
  const offerBelowExpectations = a.offer_acceptable === 'below_expectations';
  const offerVeryAttractive = a.offer_acceptable === 'very_attractive';

  // Secondary signals
  const isComplexDeal = ['carveout', 'cross_border'].includes(a.deal_complexity);
  const hasBuyerInexperience = ['first_time', 'unclear_approval'].includes(a.buyer_experience);
  const hasStakeholderMisalignment = ['significant_disagreement', 'misaligned_incentives'].includes(a.stakeholder_alignment);
  const isOverwhelmed = a.process_comfort === 'overwhelmed';

  // HIRE BANKER outcomes

  // 1. Competitive interest + leverage
  if (hasCompetitiveInterest && hasLeverage) {
    return 'hire_banker_competitive';
  }

  // 2. Offer in hand + want to test market
  if (hasOffer && offerBelowExpectations && hasLeverage) {
    return 'hire_banker_price_discovery';
  }

  // 3. High complexity even without competition
  if (isComplexDeal && !isExploring && !isBuildingRelationships) {
    return 'hire_banker_complexity';
  }

  // 4. Stakeholder misalignment
  if (hasStakeholderMisalignment) {
    return 'hire_banker_alignment';
  }

  // CONDITIONAL outcomes

  // 5. Multiple warm interest, could formalize
  if (hasWarmMultiple && hasLeverage) {
    return 'consider_banker_formalize';
  }

  // 6. Inexperienced buyer, banker can help educate
  if (hasBuyerInexperience && !isExploring && !isBuildingRelationships && !hasNoRealInterest) {
    return 'consider_banker_buyer_inexperience';
  }

  // 7. Good position but not ideal - be picky about banker
  if (hasStrongRelationships && hasLeverage && !hasCompetitiveInterest && !hasWarmMultiple) {
    return 'selective_banker_engagement';
  }

  // 8. Overwhelmed but no competition - get other help
  if (isOverwhelmed && !hasCompetitiveInterest && !hasWarmMultiple) {
    return 'get_other_help_first';
  }

  // 9. Attractive offer, may not need banker
  if (hasOffer && offerVeryAttractive && !hasCompetitiveInterest) {
    return 'early_consider_carefully';
  }

  // DON'T HIRE outcomes

  // 10. Too early, build relationships
  if ((isExploring || isBuildingRelationships) && hasNoRelationships) {
    return 'build_relationships_first';
  }

  // 11. One warm lead, nurture directly
  if (hasWarmSingle && !hasCompetitiveInterest) {
    return 'nurture_relationship_directly';
  }

  // 12. Desperate + no interest
  if (isDesperate && hasNoRealInterest) {
    return 'banker_wont_help';
  }

  // 13. No relationships, need to build first
  if (hasNoRelationships && hasNoRealInterest) {
    return 'build_relationships_first';
  }

  // Default: If exploring or early stage, build relationships
  if (isExploring || isBuildingRelationships) {
    return 'build_relationships_first';
  }

  // Fallback: selective engagement if they have some pieces
  return 'selective_banker_engagement';
}

function bankerGoBack() {
  if (bankerQuestionHistory.length > 0) {
    const prevIndex = bankerQuestionHistory.pop();
    showBankerQuestion(prevIndex);
  }
}

function showBankerResults(earlyOutcome) {
  document.getElementById('banker-question-section').classList.add('hidden');
  document.getElementById('banker-results-section').classList.remove('hidden');

  const outcomeKey = earlyOutcome || calculateBankerOutcome();
  const outcome = bankerOutcomes[outcomeKey];

  document.getElementById('banker-result-title').textContent = outcome.title;
  document.getElementById('banker-result-description').innerHTML = outcome.description;

  const chaptersList = document.getElementById('banker-chapters-list');
  chaptersList.innerHTML = '';
  outcome.chapters.forEach(ch => {
    const div = document.createElement('div');
    div.className = 'q-chapter-item';
    div.innerHTML = `<a href="ma-book/chapter-${ch.num}.html" class="q-chapter-link"><span class="q-chapter-num">Ch. ${ch.num}</span> ${ch.title}</a>`;
    chaptersList.appendChild(div);
  });
}

function restartBankerAssessment() {
  bankerAnswers = {};
  bankerCurrentQuestion = 0;
  bankerQuestionHistory = [];
  document.getElementById('banker-results-section').classList.add('hidden');
  document.getElementById('banker-question-section').classList.add('hidden');
  document.getElementById('banker-tool-content').classList.add('hidden');
  document.getElementById('banker-start-btn').classList.remove('hidden');
}

// M&A Journey Timeline Accordion
document.addEventListener('DOMContentLoaded', function() {
  const journeyStages = document.querySelectorAll('.journey-stage');

  journeyStages.forEach(function(stage, index) {
    const header = stage.querySelector('.journey-header');
    const details = stage.querySelector('.journey-details');

    // Staggered fade-in animation
    stage.style.animationDelay = (index * 0.05) + 's';

    header.addEventListener('click', function() {
      const isExpanded = header.getAttribute('aria-expanded') === 'true';

      // Close all other stages
      journeyStages.forEach(function(otherStage) {
        const otherHeader = otherStage.querySelector('.journey-header');
        const otherDetails = otherStage.querySelector('.journey-details');
        otherHeader.setAttribute('aria-expanded', 'false');
        otherStage.classList.remove('active');
        otherDetails.style.maxHeight = null;
      });

      // Toggle current stage
      if (!isExpanded) {
        header.setAttribute('aria-expanded', 'true');
        stage.classList.add('active');
        details.style.maxHeight = details.scrollHeight + 'px';
      }
    });

    // Keyboard accessibility
    header.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        header.click();
      }
    });
  });
});

</script>

<!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "c4cda5518e1c46ee8aef14c3a05321e6"}'></script><!-- End Cloudflare Web Analytics -->
</body>
</html>
